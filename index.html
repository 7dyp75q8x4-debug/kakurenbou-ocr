<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã‹ãã‚Œã‚“ã¼ OCR - å®Œå…¨ç‰ˆ</title>

<!-- Tesseract.js CDN (å®‰å®šç‰ˆ) -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>

<style>
  /* ãƒ™ãƒ¼ã‚¹ */
  :root{
    --bg:#0f0f0f;
    --panel:#161616;
    --accent:#dd2222;
    --muted:#666;
    --card:#0b0b0b;
    --btn:#333;
    --btn-h:#222;
    --ok:#1e90ff;
    --rec:#e04;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family: "Noto Sans JP",sans-serif; -webkit-user-select:none;}
  /* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ: æ¨ªæŒã¡æƒ³å®š */
  .root {
    height:100vh;
    width:100vw;
    display:flex;
    gap:8px;
    padding:8px;
    box-sizing:border-box;
    overflow:hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
  }

  /* å·¦: ãŠé¡Œç¸¦ */
  .left {
    width:14%;
    min-width:120px;
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:center;
  }
  .q-btn {
    width:98%;
    aspect-ratio:1/1;
    background:transparent;
    border:3px solid #b22222;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:20px;
    border-radius:6px;
    box-sizing:border-box;
  }
  .q-btn.small{font-size:16px;padding:6px}

  /* ä¸­å¤®: å„ãŠé¡Œã®å€™è£œï¼ˆç¸¦ã«ä¸¦ã¶ï¼‰*/
  .center {
    width:60%;
    display:flex;
    flex-direction:column;
    gap:10px;
    padding-right:6px;
    box-sizing:border-box;
    align-items:stretch;
  }
  .q-row {
    display:flex;
    gap:10px;
    align-items:center;
    height:calc((100% - 40px) / 5);
    min-height:80px;
  }
  .q-square {
    width:14%;
    aspect-ratio:1/1;
    background:#0a0a0a;
    border-radius:8px;
    border:2px solid #222;
    display:flex;
    align-items:center;
    justify-content:center;
    color:var(--muted);
    font-size:14px;
  }
  .candidates {
    flex:1;
    display:flex;
    gap:8px;
    align-items:center;
  }
  .cand {
    background:#0a0a0a;
    border-radius:8px;
    border:2px solid #222;
    width:32%;
    height:100%;
    display:flex;
    flex-direction:column;
    overflow:hidden;
    box-sizing:border-box;
  }
  .cand .thumb {
    flex:1;
    background:#111;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:16px;
    color:var(--muted);
  }
  .cand .label {
    height:34px;
    display:flex;
    align-items:center;
    justify-content:center;
    border-top:1px solid #222;
    font-weight:700;
  }

  /* å³: æ“ä½œãƒ‘ãƒãƒ« */
  .right {
    width:22%;
    min-width:200px;
    background:var(--panel);
    border-radius:10px;
    padding:10px;
    box-sizing:border-box;
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:stretch;
  }

  .status {
    background:#0b0b0b;
    padding:8px;
    border-radius:8px;
    text-align:center;
    font-size:18px;
    color:var(--ok);
    border:1px solid #222;
  }

  .controls {
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:8px;
  }
  .ctrl-btn {
    background:var(--btn);
    border-radius:8px;
    padding:10px;
    text-align:center;
    border:1px solid #222;
    font-weight:700;
    user-select:none;
  }
  .ctrl-btn.red{background:var(--rec);color:#fff}
  .ctrl-btn.small{
    padding:8px;
    aspect-ratio:1/1;
  }

  /* ã‚«ãƒ¡ãƒ©è¡¨ç¤º (å³ä¸‹ã«å°ã•ã) */
  .camera-wrap{
    margin-top:auto;
    display:flex;
    gap:8px;
    align-items:flex-end;
    justify-content:center;
  }
  .camera-box {
    width:100%;
    height:160px;
    background:#111;
    border-radius:8px;
    border:2px solid #222;
    position:relative;
    overflow:hidden;
  }
  video#camera {
    width:100%;
    height:100%;
    object-fit:cover;
    transform:scaleX(-1); /* ãƒ•ãƒ­ãƒ³ãƒˆã‚’ãƒŸãƒ©ãƒ¼è¡¨ç¤ºã€‚å¿…è¦ãªã‚‰å¤–ã—ã¦ãã ã•ã„ */
  }

  /* ãƒ­ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ */
  .log {
    position:absolute;
    right:16px;
    top:12px;
    width:260px;
    max-height:200px;
    overflow:auto;
    background:rgba(0,0,0,0.6);
    border:1px solid #333;
    padding:8px;
    border-radius:8px;
    font-size:12px;
  }

  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
  @media (max-width:900px){
    .center{width:58%}
    .right{width:28%}
    .left{width:16%}
    .camera-box{height:120px}
  }

  /* è‰²èª¿æ•´ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
  .blue{color:var(--ok)}
  .red{color:var(--rec)}
  .muted{color:var(--muted)}
</style>
</head>
<body>

<div class="root">

  <!-- LEFT: ãŠé¡Œãƒœã‚¿ãƒ³ç¾¤ -->
  <div class="left" id="left">
    <div class="q-btn" data-index="0" id="qbtn0">ãŠé¡Œ1</div>
    <div class="q-btn" data-index="1" id="qbtn1">ãŠé¡Œ2</div>
    <div class="q-btn" data-index="2" id="qbtn2">ãŠé¡Œ3</div>
    <div class="q-btn" data-index="3" id="qbtn3">ãŠé¡Œ4</div>
    <div class="q-btn" data-index="4" id="qbtn4">ãŠé¡Œ5</div>
  </div>

  <!-- CENTER: å€™è£œè¡¨ç¤ºï¼ˆãŠé¡Œ1..5ã”ã¨ï¼‰ -->
  <div class="center" id="center">
    <!-- 5è¡Œä½œã‚‹ -->
    <div class="q-row" data-index="0">
      <div class="q-square" id="qsquare0">æœªã‚»ãƒƒãƒˆ</div>
      <div class="candidates">
        <div class="cand" id="cand0-0"><div class="thumb">-</div><div class="label">å€™è£œ 1</div></div>
        <div class="cand" id="cand0-1"><div class="thumb">-</div><div class="label">å€™è£œ 2</div></div>
        <div class="cand" id="cand0-2"><div class="thumb">-</div><div class="label">å€™è£œ 3</div></div>
      </div>
    </div>

    <div class="q-row" data-index="1">
      <div class="q-square" id="qsquare1">æœªã‚»ãƒƒãƒˆ</div>
      <div class="candidates">
        <div class="cand" id="cand1-0"><div class="thumb">-</div><div class="label">å€™è£œ 1</div></div>
        <div class="cand" id="cand1-1"><div class="thumb">-</div><div class="label">å€™è£œ 2</div></div>
        <div class="cand" id="cand1-2"><div class="thumb">-</div><div class="label">å€™è£œ 3</div></div>
      </div>
    </div>

    <div class="q-row" data-index="2">
      <div class="q-square" id="qsquare2">æœªã‚»ãƒƒãƒˆ</div>
      <div class="candidates">
        <div class="cand" id="cand2-0"><div class="thumb">-</div><div class="label">å€™è£œ 1</div></div>
        <div class="cand" id="cand2-1"><div class="thumb">-</div><div class="label">å€™è£œ 2</div></div>
        <div class="cand" id="cand2-2"><div class="thumb">-</div><div class="label">å€™è£œ 3</div></div>
      </div>
    </div>

    <div class="q-row" data-index="3">
      <div class="q-square" id="qsquare3">æœªã‚»ãƒƒãƒˆ</div>
      <div class="candidates">
        <div class="cand" id="cand3-0"><div class="thumb">-</div><div class="label">å€™è£œ 1</div></div>
        <div class="cand" id="cand3-1"><div class="thumb">-</div><div class="label">å€™è£œ 2</div></div>
        <div class="cand" id="cand3-2"><div class="thumb">-</div><div class="label">å€™è£œ 3</div></div>
      </div>
    </div>

    <div class="q-row" data-index="4">
      <div class="q-square" id="qsquare4">æœªã‚»ãƒƒãƒˆ</div>
      <div class="candidates">
        <div class="cand" id="cand4-0"><div class="thumb">-</div><div class="label">å€™è£œ 1</div></div>
        <div class="cand" id="cand4-1"><div class="thumb">-</div><div class="label">å€™è£œ 2</div></div>
        <div class="cand" id="cand4-2"><div class="thumb">-</div><div class="label">å€™è£œ 3</div></div>
      </div>
    </div>
  </div>

  <!-- RIGHT: æ“ä½œ/ã‚«ãƒ¡ãƒ© -->
  <div class="right" id="right">
    <div class="status" id="status">çŠ¶æ…‹ï¼š<span id="statusText" class="blue">å¾…æ©Ÿä¸­</span></div>

    <div class="controls">
      <div class="ctrl-btn" id="modeQuestion">ğŸ“· ãŠé¡Œæ’®å½±ãƒ¢ãƒ¼ãƒ‰</div>
      <div class="ctrl-btn" id="modeSearch">ğŸ” ç•ªå·æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰</div>
      <div class="ctrl-btn small" id="btnCapture">ğŸ“¸</div>
      <div class="ctrl-btn small" id="btnReset">â™» ãŠé¡Œãƒªã‚»ãƒƒãƒˆ</div>
    </div>

    <div style="height:8px;"></div>

    <div style="font-size:13px;color:var(--muted);">é•·æŠ¼ã—ã§é€£å†™ï¼ˆ1ç§’ã”ã¨ï¼‰ãƒ»æœ€å¤§10æš</div>

    <div class="camera-wrap">
      <div class="camera-box">
        <video id="camera" autoplay muted playsinline></video>
      </div>
    </div>

  </div>

  <!-- ãƒ­ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆå³ä¸Šã«é‡ã­ã‚‹ï¼‰ -->
  <div class="log" id="log" style="display:none"></div>

</div>

<script>
/*
  å®Œå…¨ç‰ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
  - Tesseract.createWorker ã‚’ä½¿ã„ worker ã‚’ç«‹ã¡ä¸Šã’ã‚‹
  - é•·æŠ¼ã—ã§1ç§’ã”ã¨ã«ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦ OCR
  - ãŠé¡Œãƒ¢ãƒ¼ãƒ‰: è¦‹ã¤ã‹ã£ãŸ3æ¡æ•°å­—ã‚’å·¦ã‹ã‚‰é †ã«ã‚»ãƒƒãƒˆ
  - æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰: ç”»é¢å†…ã®æ•°å­—ã¨è¿‘æ¥ã™ã‚‹è‹±å­—ã‚’å€™è£œã¨ã—ã¦é›†è¨ˆ â†’ top3 ã‚’è¡¨ç¤ºï¼ˆã‚µãƒ ãƒä»˜ï¼‰
  - ãƒ­ã‚°ã¯å³ä¸Šã«è¡¨ç¤ºï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨é€²æ—ï¼‰
*/

/* ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ */
const NUM_QUESTIONS = 5;
let mode = 'question'; // 'question' or 'search'
let statusTextEl = document.getElementById('statusText');
let logEl = document.getElementById('log');
let video = document.getElementById('camera');
let canvas = document.createElement('canvas');
let ctx = canvas.getContext('2d');

/* ãƒ‡ãƒ¼ã‚¿ */
let questions = new Array(NUM_QUESTIONS).fill(null); // {num: "062", img: dataURL}
let candidates = Array.from({length:NUM_QUESTIONS}, ()=> ({})); // map: candidateChar -> {count, thumbs: [dataURL,...]}

/* Tesseract ãƒ¯ãƒ¼ã‚«ãƒ¼ (åˆæœŸåŒ–) */
let worker = null;
let workerReady = false;
(async ()=>{
  log('Tesseract ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™...');
  worker = Tesseract.createWorker({
    logger: m => {
      /* å†…éƒ¨ãƒ­ã‚°ã‚’å°ã•ãæ‹¾ã†ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰*/
      // log('tess: ' + JSON.stringify(m));
    }
  });
  await worker.load();
  await worker.loadLanguage('eng');
  await worker.initialize('eng');
  workerReady = true;
  log('OCR åˆæœŸåŒ–å®Œäº†');
})();

/* ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ï¼ˆå¤–ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆï¼‰ */
async function startCamera(){
  try{
    // try rear camera first
    const constraints = { video: { facingMode: { exact: "environment" } , width: {ideal:1280}, height:{ideal:720} }, audio:false};
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    log('ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼ˆèƒŒé¢ï¼‰');
  }catch(e){
    // fallback
    try{
      const stream = await navigator.mediaDevices.getUserMedia({video:true, audio:false});
      video.srcObject = stream;
      log('ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰');
    }catch(err){
      log('ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“: ' + err.message);
      alert('ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã€‚HTTPSã§é–‹ã„ã¦ã„ã‚‹ã‹ã€ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚ã‚¨ãƒ©ãƒ¼:' + err.message);
    }
  }
}
startCamera().catch(()=>{});

/* UI è¦ç´ å‚ç…§ & ã‚¤ãƒ™ãƒ³ãƒˆ */
document.getElementById('modeQuestion').addEventListener('click', ()=>{
  setMode('question');
});
document.getElementById('modeSearch').addEventListener('click', ()=>{
  setMode('search');
});
document.getElementById('btnReset').addEventListener('click', resetAll);

/* é•·æŠ¼ã—ã‚­ãƒ£ãƒ—ãƒãƒ£åˆ¶å¾¡ */
let pressTimer = null;
let captureInterval = null;
let capturing = false;
const CAP_MAX = 10;
let capCount = 0;

const btnCapture = document.getElementById('btnCapture');
btnCapture.addEventListener('mousedown', startPress);
btnCapture.addEventListener('touchstart', startPress);
btnCapture.addEventListener('mouseup', endPress);
btnCapture.addEventListener('mouseleave', endPress);
btnCapture.addEventListener('touchend', endPress);

function startPress(e){
  e.preventDefault();
  if(!workerReady){ log('OCR æœªæº–å‚™'); return; }
  if(capturing) return;
  // é•·æŠ¼ã—é–‹å§‹: ã¾ãšå³æ™‚ã«1æšæ’®ã‚‹
  capturing = true;
  capCount = 0;
  setStatus('æ’®å½±ä¸­', 'red');
  log(`[æ’®å½±] é•·æŠ¼ã—é–‹å§‹ - ãƒ¢ãƒ¼ãƒ‰: ${mode}`);
  captureOnce(); // immediate
  captureInterval = setInterval(()=>{
    if(capCount >= CAP_MAX){
      endPress();
      return;
    }
    captureOnce();
  }, 1000);
}

function endPress(e){
  if(!capturing) return;
  capturing = false;
  clearInterval(captureInterval);
  captureInterval = null;
  setStatus('å¾…æ©Ÿä¸­', 'blue');
  log(`[æ’®å½±] é•·æŠ¼ã—çµ‚äº†ã€‚å–å¾—æšæ•°: ${capCount}`);
}

function setStatus(text, colorClass){
  statusTextEl.textContent = text;
  if(colorClass === 'red'){
    statusTextEl.classList.remove('blue');
    statusTextEl.classList.add('red');
  } else {
    statusTextEl.classList.remove('red');
    statusTextEl.classList.add('blue');
  }
}

/* ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦ OCR å®Ÿè¡Œ */
async function captureOnce(){
  if(!video || !video.videoWidth) {
    log('ã‚«ãƒ¡ãƒ©æœªæº–å‚™');
    return;
  }
  capCount++;
  // canvas ã«ã‚µã‚¤ã‚ºåˆã‚ã›
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const dataURL = canvas.toDataURL('image/jpeg', 0.9);

  log(`ãƒ•ãƒ¬ãƒ¼ãƒ å–å¾— ${capCount}`);

  // OCR å®Ÿè¡Œï¼ˆéåŒæœŸï¼‰
  if(!workerReady) {
    log('OCR ãƒ¯ãƒ¼ã‚«ãƒ¼æœªæº–å‚™');
    return;
  }
  // result.words ã‚’ä½¿ã£ã¦ bbox æƒ…å ±ã‚’å¾—ã‚‹
  try{
    const { data } = await worker.recognize(dataURL);
    processOcrResult(data, dataURL);
  }catch(err){
    log('OCR ã‚¨ãƒ©ãƒ¼: '+ err.message);
  }
}

/* OCR çµæœã®è§£æã¨ UI æ›´æ–° */
function processOcrResult(data, dataURL){
  // data.words: array of {text, bbox:{x0,y0,x1,y1},confidence}
  const words = data.words || [];
  // 3æ¡ã®æ•°å­—ã‚’æŠ½å‡º
  const nums = [];
  const letters = [];
  for(const w of words){
    const txt = (w.text || '').trim();
    // æ•°å­—ï¼š3æ¡ã®ã¿
    const m = txt.match(/\b(\d{3})\b/);
    if(m){
      nums.push({num:m[1], box:w.bbox, conf:w.confidence});
    } else {
      // å˜ä¸€ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆï¼ˆA-Zï¼‰ã‚’æŠ½å‡º
      const t2 = txt.replace(/[^A-Za-z]/g,'').toUpperCase();
      if(t2.length === 1 && /[A-Z]/.test(t2)){
        letters.push({ch:t2, box:w.bbox, conf:w.confidence});
      }
    }
  }

  if(mode === 'question'){
    // è‡ªå‹•ã§å·¦ã‹ã‚‰é †ã«ãŠé¡Œã‚»ãƒƒãƒˆ
    if(nums.length === 0){
      log('[ãŠé¡Œãƒ¢ãƒ¼ãƒ‰] 3æ¡ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
      return;
    }
    // Sort left-to-right by bbox.x0 to determine order
    nums.sort((a,b)=> (a.box.x0||0) - (b.box.x0||0));
    for(const nobj of nums){
      // find first empty slot
      const idx = questions.findIndex(q=> q===null);
      if(idx === -1) break;
      questions[idx] = {num:nobj.num, img:dataURL};
      // update UI
      updateQuestionUI(idx);
      log(`[ãŠé¡Œãƒ¢ãƒ¼ãƒ‰] ãŠé¡Œã‚»ãƒƒãƒˆ: index=${idx}, num=${nobj.num}`);
    }
  } else if(mode === 'search'){
    // ç”»é¢ä¸­ã®æ•°å­— -> æ–‡å­—(è¿‘æ¥) ã‚’å€™è£œåŒ–
    if(nums.length === 0){
      log('[æ¢ç´¢ãƒ¢ãƒ¼ãƒ‰] 3æ¡ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
      return;
    }
    // For each detected number, find nearest letter by center-to-center distance
    for(const nobj of nums){
      const ncenter = {x: (nobj.box.x0 + nobj.box.x1)/2, y: (nobj.box.y0 + nobj.box.y1)/2};
      let nearest = null; let mind=999999;
      for(const L of letters){
        const lcenter = {x:(L.box.x0+L.box.x1)/2, y:(L.box.y0+L.box.y1)/2};
        const d = Math.hypot(ncenter.x - lcenter.x, ncenter.y - lcenter.y);
        if(d < mind){
          mind = d; nearest = L;
        }
      }
      const digit = nobj.num;
      const char = nearest ? nearest.ch : null;
      // assign candidate to whichever question slot matches the digit (if any), otherwise to the first matching question by number, else ignore
      const qidx = questions.findIndex(q => q && q.num === digit);
      let target = (qidx !== -1) ? qidx : null;
      // If question not set for this number, we still may want to record candidates in a transient bucket.
      // For simplicity: if qidx found -> add candidate; else attempt to assign to first empty question slot visually nearest? skip for now.
      if(target !== null && char){
        addCandidate(target, char, dataURL);
        log(`[æ¢ç´¢ãƒ¢ãƒ¼ãƒ‰] ${digit} -> ${char} ã‚’å€™è£œã«è¿½åŠ  (Q${target+1})`);
      } else {
        // if question not found, try to match to ANY question whose num equals digit (already checked).
        // As fallback, if char present, try to find the question slot whose thumbnail visually exists (not implemented) => store in a temporary bucket
        log(`[æ¢ç´¢ãƒ¢ãƒ¼ãƒ‰] æ•°å­— ${digit} ã®å¯¾è±¡ãŠé¡ŒãŒæœªã‚»ãƒƒãƒˆã€‚å€™è£œã¯ä¿ç•™`);
      }
    }

    // After updates, refresh candidate UI
    refreshAllCandidateUI();
  }
}

/* è³ªå•ã‚¹ãƒ­ãƒƒãƒˆã®UIæ›´æ–° */
function updateQuestionUI(idx){
  const q = questions[idx];
  const el = document.getElementById('qsquare' + idx);
  if(!q){
    el.textContent = 'æœªã‚»ãƒƒãƒˆ';
    return;
  }
  // thumbnail from q.img
  el.innerHTML = '<img src="'+q.img+'" style="width:100%;height:100%;object-fit:cover">';
}

/* å€™è£œã‚’è¿½åŠ  */
function addCandidate(qidx, ch, thumbDataUrl){
  if(!candidates[qidx][ch]) candidates[qidx][ch] = {count:0, thumbs:[]};
  candidates[qidx][ch].count++;
  if(thumbnailIsUnique(candidates[qidx][ch].thumbs, thumbDataUrl)){
    candidates[qidx][ch].thumbs.push(thumbDataUrl);
    if(candidates[qidx][ch].thumbs.length > 3) candidates[qidx][ch].thumbs.shift();
  }
}

/* å˜ç´”ãªåŒä¸€ã‚µãƒ ãƒé‡è¤‡é˜²æ­¢ */
function thumbnailIsUnique(arr, dataUrl){
  if(!dataUrl) return false;
  if(arr.length === 0) return true;
  // naive compare prefix
  return arr.every(a => a.slice(0,30) !== dataUrl.slice(0,30));
}

/* å€™è£œ UI ã‚’æ›´æ–°ï¼ˆtop3 ã‚’è¡¨ç¤ºï¼‰ */
function refreshAllCandidateUI(){
  for(let i=0;i<NUM_QUESTIONS;i++){
    refreshCandidateUI(i);
  }
}
function refreshCandidateUI(i){
  const map = candidates[i];
  const list = Object.keys(map).map(k=>({ch:k, count:map[k].count, thumbs:map[k].thumbs}));
  list.sort((a,b)=>b.count - a.count);
  for(let j=0;j<3;j++){
    const slot = document.getElementById(`cand${i}-${j}`);
    const thumb = slot.querySelector('.thumb');
    const label = slot.querySelector('.label');
    if(list[j]){
      // show top candidate (letter and first thumb)
      label.textContent = `${list[j].ch} (${list[j].count})`;
      thumb.innerHTML = `<img src="${list[j].thumbs[0]}" style="width:100%;height:100%;object-fit:cover">`;
    } else {
      label.textContent = `å€™è£œ ${j+1}`;
      thumb.textContent = '-';
      thumb.innerHTML = '';
    }
  }
}

/* å…¨ãƒªã‚»ãƒƒãƒˆ */
function resetAll(){
  questions = new Array(NUM_QUESTIONS).fill(null);
  candidates = Array.from({length:NUM_QUESTIONS}, ()=> ({}));
  for(let i=0;i<NUM_QUESTIONS;i++){
    document.getElementById('qsquare'+i).textContent = 'æœªã‚»ãƒƒãƒˆ';
    for(let j=0;j<3;j++){
      const slot = document.getElementById(`cand${i}-${j}`);
      slot.querySelector('.thumb').textContent = '-';
      slot.querySelector('.label').textContent = `å€™è£œ ${j+1}`;
    }
  }
  log('[æ“ä½œ] å…¨ãƒªã‚»ãƒƒãƒˆ');
}

/* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ */
function setMode(m){
  mode = m;
  if(mode === 'question'){
    document.getElementById('modeQuestion').style.border='2px solid #1e90ff';
    document.getElementById('modeSearch').style.border='1px solid #222';
    log('[ãƒ¢ãƒ¼ãƒ‰] ãŠé¡Œæ’®å½±ãƒ¢ãƒ¼ãƒ‰');
  } else {
    document.getElementById('modeSearch').style.border='2px solid #1e90ff';
    document.getElementById('modeQuestion').style.border='1px solid #222';
    log('[ãƒ¢ãƒ¼ãƒ‰] ç•ªå·æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰');
  }
}

/* ãƒ­ã‚°å‡ºåŠ›ï¼ˆå°çª“ã«æµã™ï¼‰ */
function log(s){
  const t = new Date().toLocaleTimeString();
  const line = `[${t}] ${s}`;
  console.log(line);
  if(!logEl) return;
  logEl.style.display='block';
  const div = document.createElement('div');
  div.textContent = line;
  logEl.prepend(div);
  // limit
  while(logEl.children.length > 80) logEl.removeChild(logEl.lastChild);
}

/* åˆæœŸè¨­å®š: ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º */
setMode('question');
setStatus('å¾…æ©Ÿä¸­', 'blue');

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«èª¬æ˜ (console) */
log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†ã€‚ğŸ‘‰ é•·æŠ¼ã—ã§æ’®å½±ã€ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚');

</script>

</body>
</html>
