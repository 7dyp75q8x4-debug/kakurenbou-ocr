<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‹ãã‚Œã‚“ã¼OCR â€“ å®Œå…¨å‹•ä½œç‰ˆ</title>
<style>
    body {
        margin: 0;
        background: #111;
        color: white;
        font-family: sans-serif;
        overflow: hidden;
    }

    .container {
        display: flex;
        flex-direction: row;
        height: 100vh;
        width: 100vw;
    }

    /* ã‚«ãƒ¡ãƒ©ã‚¨ãƒªã‚¢ */
    #cameraArea {
        flex: 2;
        background: #000;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: none; /* â† ãƒŸãƒ©ãƒ¼è§£é™¤ï¼ˆå¤–ã‚«ãƒ¡ãƒ©ãªã‚‰å·¦å³åè»¢ã—ãªã„ï¼‰ */
    }

    /* å³å´ã®æ“ä½œãƒ‘ãƒãƒ« */
    #controlArea {
        flex: 1;
        background: #333;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    button {
        padding: 20px;
        font-size: 2vw;
        border-radius: 10px;
        border: none;
        background: #555;
        color: white;
    }

    #modeDisplay {
        font-size: 2.3vw;
        text-align: center;
        padding: 20px;
        background: #222;
        border-radius: 10px;
    }

    #progress {
        font-size: 1.8vw;
        text-align: center;
    }
</style>
</head>
<body>

<div class="container">

    <div id="cameraArea">
        <video id="video" autoplay playsinline></video>
    </div>

    <div id="controlArea">

        <div id="modeDisplay">ç¾åœ¨ï¼šãŠé¡Œæ’®å½±ãƒ¢ãƒ¼ãƒ‰</div>

        <button onclick="setMode('odai')">ğŸ“¸ ãŠé¡Œæ’®å½±ãƒ¢ãƒ¼ãƒ‰</button>
        <button onclick="setMode('search')">ğŸ” ã‚«ãƒ¼ãƒ‰æ¢ç´¢ãƒ¢ãƒ¼ãƒ‰</button>
        <button onclick="setMode('cameraTest')">ğŸ¥ ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</button>

        <button id="startCapture">ğŸ”´ é•·æŠ¼ã—ã§æ’®å½±</button>

        <div id="progress">é€£å†™å¾…æ©Ÿä¸­â€¦</div>
    </div>

</div>

<script>
let mode = "odai";
let stream = null;
let capturing = false;
let captureInterval = null;
let capturedImages = [];

/* ============================
   ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
============================ */
function setMode(newMode) {
    mode = newMode;

    const modeText = {
        "odai": "ç¾åœ¨ï¼šãŠé¡Œæ’®å½±ãƒ¢ãƒ¼ãƒ‰",
        "search": "ç¾åœ¨ï¼šã‚«ãƒ¼ãƒ‰æ¢ç´¢ãƒ¢ãƒ¼ãƒ‰",
        "cameraTest": "ç¾åœ¨ï¼šã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰"
    };

    document.getElementById("modeDisplay").innerText = modeText[newMode];
}

/* ============================
   å¤–ã‚«ãƒ¡ãƒ©èµ·å‹•
============================ */
async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: { exact: "environment" },  // â˜… å¤–ã‚«ãƒ¡ãƒ©å¼·åˆ¶
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            },
            audio: false
        });
    } catch (e) {
        console.warn("å¤–ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•— â†’ å†…ã‚«ãƒ¡ãƒ© fallback");

        stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: false
        });
    }

    document.getElementById("video").srcObject = stream;
}

startCamera();

/* ============================
   é•·æŠ¼ã—æ’®å½±ï¼ˆ1ç§’ã”ã¨ã«æœ€å¤§10æšï¼‰
============================ */

const button = document.getElementById("startCapture");

button.addEventListener("touchstart", () => startCapturing());
button.addEventListener("mousedown", () => startCapturing());

button.addEventListener("touchend", () => stopCapturing());
button.addEventListener("mouseup", () => stopCapturing());
button.addEventListener("mouseleave", () => stopCapturing());

function startCapturing() {
    if (capturing) return; // 2é‡é˜²æ­¢
    capturing = true;
    capturedImages = [];

    document.getElementById("progress").innerText = "æ’®å½±ä¸­â€¦ 0/10";

    captureInterval = setInterval(() => {
        if (capturedImages.length >= 10) {
            stopCapturing();
            return;
        }
        takePicture();
    }, 1000);
}

function stopCapturing() {
    capturing = false;
    clearInterval(captureInterval);

    document.getElementById("progress").innerText =
        `æ’®å½±çµ‚äº†ï¼š${capturedImages.length}æš`;

    console.log("æ’®å½±ã—ãŸç”»åƒãƒ‡ãƒ¼ã‚¿ï¼š", capturedImages);
}

function takePicture() {
    const video = document.getElementById("video");

    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    const imgData = canvas.toDataURL("image/png");
    capturedImages.push(imgData);

    document.getElementById("progress").innerText =
        `æ’®å½±ä¸­â€¦ ${capturedImages.length}/10`;
}
</script>

</body>
</html>
