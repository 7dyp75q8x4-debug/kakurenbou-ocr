<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Scanner UI</title>
<style>
    body {
        margin:0;
        padding:0;
        background:#111;
        color:white;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        overflow:hidden;
        touch-action:none;
    }

    /* 横画面固定レイアウト */
    #root {
        display:flex;
        width:100vw;
        height:100vh;
        flex-direction:row;
    }

    /* 左：5×4 スロットエリア */
    #grid {
        width:65vw; 
        height:100vh;
        display:grid;
        grid-template-columns: repeat(5, 1fr);
        grid-template-rows: repeat(4, 1fr);
        gap:8px;
        padding:10px;
        box-sizing:border-box;
    }

    .slot {
        position:relative;
        border:2px solid #ccc;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:22px;
        color:white;
        background:#000;
    }

    .slot img {
        width:100%;
        height:100%;
        object-fit:contain;
    }

    /* 右側エリア */
    #side {
        width:35vw;
        height:100vh;
        display:flex;
        flex-direction:column;
        box-sizing:border-box;
        padding:10px;
    }

    video {
        width:100%;
        aspect-ratio: 3/4;
        background:black;
        border:2px solid #666;
    }

    #btns {
        margin-top:10px;
        display:grid;
        grid-template-columns: repeat(2, 1fr);
        gap:10px;
    }

    button {
        padding:12px;
        font-size:18px;
        background:#222;
        color:white;
        border:2px solid #555;
        border-radius:6px;
    }

    #log {
        flex:1;
        margin-top:10px;
        background:#000;
        border:1px solid #444;
        padding:10px;
        font-size:14px;
        overflow-y:auto;
        white-space:pre-wrap;
    }
</style>
</head>
<body>

<div id="root">

    <!-- 左：5×4 グリッド -->
    <div id="grid">
        <!-- 自動生成するので空のままOK -->
    </div>

    <!-- 右：カメラ + ボタン + ログ -->
    <div id="side">
        <video id="camera" autoplay playsinline></video>

        <div id="btns">
            <button onclick="takePhoto()">撮影</button>
            <button onclick="clearLog()">ログ消去</button>
            <button onclick="nextSlot()">次へ</button>
            <button onclick="resetSlots()">リセット</button>
        </div>

        <div id="log"></div>
    </div>

</div>

<script>
/* ▼ グリッド初期化（番号001〜020） ▼ */
let currentSlot = 0;
const grid = document.getElementById("grid");

for(let i=1;i<=20;i++){
    const div = document.createElement("div");
    div.className = "slot";
    div.textContent = String(i).padStart(3,"0");
    grid.appendChild(div);
}

const slots = document.querySelectorAll(".slot");

/* ▼ カメラ起動 ▼ */
const video = document.getElementById("camera");

navigator.mediaDevices.getUserMedia({
    video:{
        facingMode:"environment",
        width:{ideal:1920},
        height:{ideal:1080}
    }
}).then(stream=>{
    video.srcObject = stream;
});

/* ▼ OCR（Tesseract.js） ▼ */
function loadOCR(){
    return new Promise(resolve=>{
        if(window.Tesseract){
            resolve();
            return;
        }
        const script = document.createElement("script");
        script.src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js";
        script.onload=()=>resolve();
        document.body.appendChild(script);
    });
}

/* ▼ 撮影＋OCR処理 ▼ */
async function takePhoto(){
    await loadOCR();

    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video,0,0);

    const base64 = canvas.toDataURL("image/png");

    // スロットに画像を入れる
    slots[currentSlot].innerHTML = `<img src="${base64}">`;

    // OCR実行
    const result = await Tesseract.recognize(base64,"eng",{});

    addLog(`Slot ${currentSlot+1}: ${result.data.text.trim()}`);

    nextSlot();
}

/* ▼ スロット移動 ▼ */
function nextSlot(){
    currentSlot = Math.min(19, currentSlot + 1);
}

/* ▼ スロット＆ログリセット ▼ */
function resetSlots(){
    for(let i=0;i<20;i++){
        slots[i].innerHTML = String(i+1).padStart(3,"0");
    }
    currentSlot = 0;
    clearLog();
}

function clearLog(){
    document.getElementById("log").textContent = "";
}

function addLog(t){
    const log = document.getElementById("log");
    log.textContent += t + "\n";
}
</script>

</body>
</html>
