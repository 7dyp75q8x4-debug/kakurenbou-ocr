<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆå®Œå…¨ç‰ˆ</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  background: #000;
}

/* ã‚«ãƒ¡ãƒ©ç”»é¢ï¼ˆå·¦å´ï¼‰ */
#camera {
  position: absolute;
  top: 0;
  left: 0;
  width: calc(100vw - 260px);
  height: 100vh;
  background: black;
  object-fit: cover;
}

/* å³ã® UI ãƒ‘ãƒãƒ« */
#ui {
  position: absolute;
  top: 0;
  right: 0;
  width: 260px;
  height: 100vh;
  background: #111;
  color: #fff;
  padding: 12px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* ãƒœã‚¿ãƒ³ */
.btn {
  width: 100%;
  height: 70px;
  background: #333;
  border: none;
  color: white;
  border-radius: 10px;
  font-size: 18px;
}

#shootBtn {
  background: #c22;
}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
#status {
  background: #1e3cff;
  padding: 12px;
  text-align: center;
  border-radius: 10px;
  font-size: 20px;
}

/* çµæœè¡¨ç¤º */
#resultBox {
  background: #222;
  padding: 8px;
  border-radius: 10px;
  margin-top: 10px;
  height: 200px;
  overflow-y: auto;
}
</style>
</head>

<body>

<!-- â˜… ã‚«ãƒ¡ãƒ©æ˜ åƒï¼ˆã“ã‚ŒãŒæ˜ ã‚‰ãªã„ã¨ãã¯ã‚«ãƒ¡ãƒ©æ¨©é™ã‹ facingMode ãŒåŸå› ï¼‰ -->
<video id="camera" autoplay playsinline muted></video>

<!-- UIãƒ‘ãƒãƒ« -->
<div id="ui">
  <div id="status">å¾…æ©Ÿä¸­</div>
  <button class="btn" onclick="setMode('topic')">ğŸ“¸ ãŠé¡Œæ’®å½±</button>
  <button class="btn" onclick="setMode('search')">ğŸ” ã‚«ãƒ¼ãƒ‰æ¢ç´¢</button>

  <button id="shootBtn" class="btn"
    onmousedown="startHold()" onmouseup="stopHold()"
    ontouchstart="startHold()" ontouchend="stopHold()">ğŸ“¸ é•·æŠ¼ã—æ’®å½±</button>

  <div id="resultBox">
    <div><b>ãŠé¡Œ:</b> <span id="topicText">ãªã—</span></div>
    <div style="margin-top:10px;"><b>å€™è£œTOP3:</b></div>
    <div id="candidates">ãƒ¼</div>
  </div>
</div>

<script>
let stream = null;
let mode = "topic";
let holding = false;
let timer = null;

/* ============================
   ğŸ“Œ iPhone ã§æœ€ã‚‚ç¢ºå®Ÿã«æ˜ ã‚‹ã‚«ãƒ¡ãƒ©èµ·å‹•
============================ */
async function startCamera() {
  if (stream) stream.getTracks().forEach(t => t.stop());

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: "environment" },  // â† iOSã¯idealãŒæœ€å¼·
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false
    });

    const video = document.getElementById("camera");
    video.srcObject = stream;

  } catch (e) {
    console.error("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:", e);
    alert("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã€‚è¨­å®šâ†’ã“ã®ã‚µã‚¤ãƒˆâ†’ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
  }
}

startCamera();

/* --- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ --- */
function setMode(m) {
  mode = m;
  document.getElementById("status").textContent = "å¾…æ©Ÿä¸­";
}

/* --- é•·æŠ¼ã—æ’®å½±å‡¦ç† --- */
function startHold() {
  holding = true;
  document.getElementById("status").textContent = "æ’®å½±ä¸­â€¦";

  timer = setTimeout(() => {
    if (holding) takePhoto();
  }, 500);
}

function stopHold() {
  holding = false;
  clearTimeout(timer);
  document.getElementById("status").textContent = "å¾…æ©Ÿä¸­";
}

/* --- æ’®å½± --- */
function takePhoto() {
  const video = document.getElementById("camera");

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0);

  const imgData = canvas.toDataURL("image/jpeg");

  console.log("æ’®å½±å®Œäº†:", imgData);

  // ä»®ã®å‡¦ç†ï¼ˆOCR ã¾ã å…¥ã‚Œã¦ãªã„ã®ã§å›ºå®šå€¤ï¼‰
  if (mode === "topic") {
    document.getElementById("topicText").textContent = "123"; // â† æœ¬æ¥ã¯ OCR çµæœ
  } else {
    document.getElementById("candidates").innerHTML =
      "1ä½: ã‚Šã‚“ã”<br>2ä½: ãƒãƒŠãƒŠ<br>3ä½: ãƒ¡ãƒ­ãƒ³";
  }
}
</script>

</body>
</html>
