<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã‹ãã‚Œã‚“ã¼ OCR â€” æœ€çµ‚ç‰ˆ</title>

<!-- Tesseract.js CDN -->
<script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

<style>
  :root{
    --bg:#000;
    --panel:#0f0f10;
    --card:#121212;
    --accent:#c42b2b;
    --glass: rgba(255,255,255,0.03);
    --white: #fff;
  }
  html,body{height:100%; margin:0; background:var(--bg); color:var(--white); font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",sans-serif; -webkit-font-smoothing:antialiased;}
  /* Outer grid: left(å›ºå®šå¹…) / center(ãƒ•ãƒ¬ã‚­ã‚·ãƒ–ãƒ«) / right(25%) */
  #root{
    height:100vh; display:grid; grid-template-columns: 100px 1fr 25vw; gap:8px; padding:8px; box-sizing:border-box; align-items:stretch;
  }

  /* Left column (5 squares stacked) */
  .left{
    display:flex; flex-direction:column; gap:8px;
  }
  .topicCell{
    flex:1 1 0; /* equal height for 5 cells */
    min-height:0;
    background:var(--panel); border-radius:8px; border:3px solid #b71c1c; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;
  }
  .topicLabel{ position:absolute; left:8px; top:8px; font-weight:800; font-size:18px; }
  .topicCell img{ width:100%; height:100%; object-fit:cover; display:block; }

  /* Center column: candidate blocks stacked (may scroll if many) */
  .center{
    display:flex; flex-direction:column; gap:8px; overflow-y:auto; padding-right:4px;
    box-sizing:border-box;
  }
  .candidateBlock{
    background:var(--card); border-radius:10px; padding:10px; border:2px solid #222; display:flex; gap:8px; align-items:center;
    height:calc((100vh - 16px*2 - 8px*4) / 5 - 8px); /* attempt to match left heights (approx) */
    box-sizing:border-box;
  }
  .candidateItem{ background:#111; border-radius:8px; padding:8px; width:33%; display:flex; gap:8px; align-items:center; box-sizing:border-box; border:1px solid var(--glass); }
  .candidateItem img{ width:64px; height:64px; object-fit:cover; border-radius:6px; background:#000; }
  .candidateLabel{ font-size:16px; line-height:1.0; }

  /* Right column */
  .right{
    display:flex; flex-direction:column; gap:8px; box-sizing:border-box; align-items:stretch; justify-content:flex-start;
  }

  /* Top small controls: 2x2 grid of square buttons */
  .controls{
    display:grid; grid-template-columns: 1fr 1fr; gap:8px;
  }
  .controlBtn{
    aspect-ratio:1/1; /* square */
    background:#222; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px; cursor:pointer; border:2px solid var(--glass); color:var(--white);
    user-select:none;
  }
  .controlBtn.active{ outline:3px solid rgba(30,140,255,0.25); box-shadow:0 2px 8px rgba(0,0,0,0.4); }

  /* Status badge near top of right column */
  #statusBadge{
    margin-top:6px; background:linear-gradient(180deg,#1e3cff,#1848ff); color:#fff; padding:8px 10px; border-radius:10px; text-align:center; font-weight:700;
  }

  /* Right bottom: small camera preview block */
  .camWrap{ margin-top:auto; display:flex; flex-direction:column; gap:8px; align-items:center; }
  .camBox{ width:100%; background:#000; border-radius:10px; overflow:hidden; border:3px solid #333; display:flex; align-items:center; justify-content:center; }
  /* camera width = 100% of right column (which is 25vw). We asked small: A(25% of screen), so right column was 25vw already */
  #camera{ width:100%; height:160px; object-fit:cover; display:block; background:#000; }

  /* bottom small hint */
  .hint{ font-size:12px; opacity:0.8; text-align:center; padding:4px 0; color:#ddd; }

  /* responsive small adjustments */
  @media(max-width:900px){
    /* reduce camera height a bit on small screens */
    #camera{ height:140px; }
    .candidateBlock{ height:120px; }
    .candidateItem img{ width:56px; height:56px; }
  }
  @media(max-height:600px){
    .candidateBlock{ height:100px; }
  }
</style>
</head>
<body>
<div id="root">
  <!-- LEFT: topics 1..5 -->
  <div class="left" id="leftCol">
    <div class="topicCell" id="t1"><div class="topicLabel">ãŠé¡Œ1</div><img id="img_t1" alt=""></div>
    <div class="topicCell" id="t2"><div class="topicLabel">ãŠé¡Œ2</div><img id="img_t2" alt=""></div>
    <div class="topicCell" id="t3"><div class="topicLabel">ãŠé¡Œ3</div><img id="img_t3" alt=""></div>
    <div class="topicCell" id="t4"><div class="topicLabel">ãŠé¡Œ4</div><img id="img_t4" alt=""></div>
    <div class="topicCell" id="t5"><div class="topicLabel">ãŠé¡Œ5</div><img id="img_t5" alt=""></div>
  </div>

  <!-- CENTER: candidate top3 blocks for each topic -->
  <div class="center" id="centerCol">
    <div class="candidateBlock" id="cand1">
      <div class="candidateItem"><img id="c1_1_img"><div class="candidateLabel" id="c1_1_txt">â€”</div></div>
      <div class="candidateItem"><img id="c1_2_img"><div class="candidateLabel" id="c1_2_txt">â€”</div></div>
      <div class="candidateItem"><img id="c1_3_img"><div class="candidateLabel" id="c1_3_txt">â€”</div></div>
    </div>

    <div class="candidateBlock" id="cand2">
      <div class="candidateItem"><img id="c2_1_img"><div class="candidateLabel" id="c2_1_txt">â€”</div></div>
      <div class="candidateItem"><img id="c2_2_img"><div class="candidateLabel" id="c2_2_txt">â€”</div></div>
      <div class="candidateItem"><img id="c2_3_img"><div class="candidateLabel" id="c2_3_txt">â€”</div></div>
    </div>

    <div class="candidateBlock" id="cand3">
      <div class="candidateItem"><img id="c3_1_img"><div class="candidateLabel" id="c3_1_txt">â€”</div></div>
      <div class="candidateItem"><img id="c3_2_img"><div class="candidateLabel" id="c3_2_txt">â€”</div></div>
      <div class="candidateItem"><img id="c3_3_img"><div class="candidateLabel" id="c3_3_txt">â€”</div></div>
    </div>

    <div class="candidateBlock" id="cand4">
      <div class="candidateItem"><img id="c4_1_img"><div class="candidateLabel" id="c4_1_txt">â€”</div></div>
      <div class="candidateItem"><img id="c4_2_img"><div class="candidateLabel" id="c4_2_txt">â€”</div></div>
      <div class="candidateItem"><img id="c4_3_img"><div class="candidateLabel" id="c4_3_txt">â€”</div></div>
    </div>

    <div class="candidateBlock" id="cand5">
      <div class="candidateItem"><img id="c5_1_img"><div class="candidateLabel" id="c5_1_txt">â€”</div></div>
      <div class="candidateItem"><img id="c5_2_img"><div class="candidateLabel" id="c5_2_txt">â€”</div></div>
      <div class="candidateItem"><img id="c5_3_img"><div class="candidateLabel" id="c5_3_txt">â€”</div></div>
    </div>
  </div>

  <!-- RIGHT: controls (2x2 small square buttons) and camera at bottom right -->
  <div class="right" id="rightCol">
    <div class="controls" id="controlsGrid">
      <div class="controlBtn" id="btnTopic" title="ãŠé¡Œæ’®å½±ãƒ¢ãƒ¼ãƒ‰">ğŸ“¸</div>
      <div class="controlBtn" id="btnSearch" title="ã‚«ãƒ¼ãƒ‰æ¢ç´¢ãƒ¢ãƒ¼ãƒ‰">ğŸ”</div>
      <div class="controlBtn" id="btnReset" title="ãƒªã‚»ãƒƒãƒˆ">â™»ï¸</div>
      <div class="controlBtn" id="btnShoot" title="é•·æŠ¼ã—ã§æ’®å½±">â—</div>
    </div>

    <div id="statusBadge">ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­â€¦</div>

    <div class="camWrap">
      <div class="camBox"><video id="camera" autoplay playsinline muted></video></div>
      <div class="hint">é•·æŠ¼ã—ã§é€£ç¶šæ’®å½±ï¼ˆ1sé–“éš”ï¼‰ãƒ»é›¢ã™ã¨åœæ­¢</div>
    </div>
  </div>
</div>

<script>
/* =========================
   å®šæ•°ãƒ»çŠ¶æ…‹
   ========================= */
const SCAN_INTERVAL_MS = 1000; // 1000ms: 1ç§’ã”ã¨ã«OCRï¼ˆè² è·ãŒé«˜ã‘ã‚Œã°1500ã€œ2000ã«ï¼‰
const MAX_TOPICS = 5;

let mode = 'topic'; // 'topic' or 'search'
let isHolding = false;
let holdTimer = null;

let topics = []; // [{num:'123', imgData:...}, ...]
let numberMap = {}; // num -> {counts:{A:3,...}, examples:[{img,letter}]}

/* Tesseract worker */
let worker = null;

/* DOM */
const statusBadge = document.getElementById('statusBadge');
const video = document.getElementById('camera');
const tmpCanvas = document.createElement('canvas');
const tmpCtx = tmpCanvas.getContext('2d');

const btnTopic = document.getElementById('btnTopic');
const btnSearch = document.getElementById('btnSearch');
const btnReset = document.getElementById('btnReset');
const btnShoot = document.getElementById('btnShoot');

/* =========================
   åˆæœŸï¼šUIåˆæœŸåŒ–
   ========================= */
function clearAllUI(){
  for(let i=1;i<=MAX_TOPICS;i++){
    document.getElementById('img_t'+i).removeAttribute('src');
    for(let j=1;j<=3;j++){
      const img = document.getElementById(`c${i}_${j}_img`);
      const txt = document.getElementById(`c${i}_${j}_txt`);
      img.removeAttribute('src');
      txt.textContent = 'â€”';
    }
  }
}
clearAllUI();

/* =========================
   Tesseract åˆæœŸåŒ–
   ========================= */
async function initTess(){
  statusBadge.textContent = 'ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­â€¦';
  worker = Tesseract.createWorker({
    logger: m => {
      if(m.status) {
        //show short status for user
        if(m.status.includes('loaded')) statusBadge.textContent = 'ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å®Œäº†';
      }
    }
  });
  await worker.load();
  await worker.loadLanguage('eng');
  await worker.initialize('eng');
  await worker.setParameters({
    tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz',
    preserve_interword_spaces: '0'
  });
  statusBadge.textContent = 'æº–å‚™å®Œäº†ï¼ˆå¾…æ©Ÿä¸­ï¼‰';
}
initTess();

/* =========================
   ã‚«ãƒ¡ãƒ©é–‹å§‹
   ========================= */
async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' }, width:{ideal:1280}, height:{ideal:720} },
      audio:false
    });
    video.srcObject = stream;
    await video.play();
    statusBadge.textContent = 'ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼ˆå¾…æ©Ÿä¸­ï¼‰';
  }catch(err){
    console.error(err);
    statusBadge.textContent = 'ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—';
  }
}
startCamera();

/* =========================
   OCRãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼šãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è§£æã—ã¦å˜èªé…åˆ—ã‚’è¿”ã™
   ========================= */
async function ocrFrame(canvas){
  if(!worker) return [];
  try{
    const res = await worker.recognize(canvas);
    const words = (res && res.data && res.data.words) ? res.data.words.map(w=>({
      text: (w.text||'').replace(/\s+/g,''),
      bbox: { x0:w.bbox.x0, y0:w.bbox.y0, x1:w.bbox.x1, y1:w.bbox.y1 },
      conf: w.confidence
    })) : [];
    return words;
  }catch(e){
    console.error('OCR error', e);
    return [];
  }
}

/* =========================
   åˆ‡ã‚ŠæŠœããƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   bbox = {x0,y0,x1,y1}
   expand = fraction
   ========================= */
function cropSquareDataURL(canvas, bbox, expand=0.25){
  const w = canvas.width, h = canvas.height;
  const bw = bbox.x1 - bbox.x0;
  const bh = bbox.y1 - bbox.y0;
  const cx = (bbox.x0 + bbox.x1)/2;
  const cy = (bbox.y0 + bbox.y1)/2;
  const size = Math.max(bw,bh) * (1 + expand);
  const sx = Math.max(0, Math.round(cx - size/2));
  const sy = Math.max(0, Math.round(cy - size/2));
  const sW = Math.min(w - sx, Math.round(size));
  const sH = Math.min(h - sy, Math.round(size));
  const tmp = document.createElement('canvas');
  tmp.width = sW; tmp.height = sH;
  tmp.getContext('2d').drawImage(canvas, sx, sy, sW, sH, 0,0, sW, sH);
  // normalize to square small size
  const out = document.createElement('canvas');
  const S = 220; // display size for left column elems (square)
  out.width = S; out.height = S;
  out.getContext('2d').drawImage(tmp, 0,0, S,S);
  return out.toDataURL('image/jpeg', 0.9);
}

/* =========================
   ã‚¹ã‚­ãƒ£ãƒ³æœ¬ä½“ï¼ˆ1ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰: topic / search å…±é€šå…¥å£
   ========================= */
async function scanOnce(){
  if(!video || !video.videoWidth) return;
  tmpCanvas.width = video.videoWidth;
  tmpCanvas.height = video.videoHeight;
  tmpCtx.drawImage(video, 0, 0, tmpCanvas.width, tmpCanvas.height);

  const words = await ocrFrame(tmpCanvas);
  if(!words || words.length===0) return;

  const threeDigits = words.filter(w => /^\d{3}$/.test(w.text));
  if(threeDigits.length === 0) return;

  if(mode === 'topic'){
    for(const w of threeDigits){
      const n = w.text;
      // avoid duplicate topic num
      if(topics.find(t=>t.num===n)) continue;
      if(topics.length >= MAX_TOPICS) break;
      const dataUrl = cropSquareDataURL(tmpCanvas, w.bbox, 0.4);
      topics.push({num:n, img:dataUrl});
      updateTopicsUI();
      if(topics.length >= MAX_TOPICS) break;
    }
  } else if(mode === 'search'){
    const letters = words.filter(w=>/^[A-Za-z]$/.test(w.text));
    for(const w of threeDigits){
      const num = w.text;
      const cx = (w.bbox.x0 + w.bbox.x1)/2;
      const cy = (w.bbox.y0 + w.bbox.y1)/2;
      let nearest=null; let bestD=Infinity;
      for(const L of letters){
        const lx=(L.bbox.x0+L.bbox.x1)/2;
        const ly=(L.bbox.y0+L.bbox.y1)/2;
        const d = Math.hypot(lx-cx, ly-cy);
        if(d<bestD){ bestD=d; nearest=L; }
      }
      const diag = Math.hypot(tmpCanvas.width, tmpCanvas.height);
      let letter = '-';
      if(nearest && bestD < diag*0.18) letter = nearest.text.toUpperCase();
      const imgExample = cropSquareDataURL(tmpCanvas, w.bbox, 0.5);
      if(!numberMap[num]) numberMap[num] = {counts:{}, examples:[]};
      if(letter !== '-') numberMap[num].counts[letter] = (numberMap[num].counts[letter]||0) + 1;
      numberMap[num].examples.unshift({letter, img: imgExample});
    }
    updateCandidatesUI();
  }
}

/* =========================
   UI update: left topics
   ========================= */
function updateTopicsUI(){
  for(let i=1;i<=MAX_TOPICS;i++){
    const el = document.getElementById('img_t'+i);
    if(topics[i-1]) el.src = topics[i-1].img;
    else el.removeAttribute('src');
  }
}

/* =========================
   UI update: candidates center
   ========================= */
function updateCandidatesUI(){
  for(let i=0;i<MAX_TOPICS;i++){
    const topic = topics[i];
    for(let j=1;j<=3;j++){
      const imgEl = document.getElementById(`c${i+1}_${j}_img`);
      const txtEl = document.getElementById(`c${i+1}_${j}_txt`);
      if(!topic){
        imgEl.removeAttribute('src');
        txtEl.textContent = 'â€”';
        continue;
      }
      const info = numberMap[topic.num];
      if(!info){
        imgEl.removeAttribute('src');
        txtEl.textContent = 'â€”';
        continue;
      }
      // sort counts
      const pairs = Object.entries(info.counts).map(([k,v])=>({k,v}));
      pairs.sort((a,b)=>b.v-a.v);
      if(pairs[j-1]){
        const letter = pairs[j-1].k;
        const ex = info.examples.find(e=>e.letter===letter) || info.examples[0];
        imgEl.src = ex ? ex.img : '';
        txtEl.textContent = `${letter} (${(info.counts[letter]||0)})`;
      } else {
        // fallback to examples
        const ex = info.examples[j-1] || info.examples[0];
        if(ex){
          imgEl.src = ex.img;
          txtEl.textContent = ex.letter==='-' ? 'å€™è£œ' : ex.letter;
        } else {
          imgEl.removeAttribute('src');
          txtEl.textContent = 'â€”';
        }
      }
    }
  }
}

/* =========================
   é•·æŠ¼ã—ï¼ˆæ’®å½±ï¼‰åˆ¶å¾¡
   ========================= */
function startHolding(){
  if(isHolding) return;
  isHolding = true;
  statusBadge.textContent = 'æ’®å½±ä¸­â€¦';
  btnShoot.classList.add('active');
  // immediate first scan then interval
  scanOnce();
  holdTimer = setInterval(scanOnce, SCAN_INTERVAL_MS);
}
function stopHolding(){
  if(!isHolding) return;
  isHolding = false;
  statusBadge.textContent = 'å¾…æ©Ÿä¸­';
  btnShoot.classList.remove('active');
  clearInterval(holdTimer); holdTimer = null;
}

/* events */
btnShoot.addEventListener('touchstart', e=>{ e.preventDefault(); startHolding(); });
btnShoot.addEventListener('mousedown', e=>{ e.preventDefault(); startHolding(); });
document.addEventListener('touchend', ()=> stopHolding());
document.addEventListener('mouseup', ()=> stopHolding());

/* =========================
   Mode buttons & reset
   ========================= */
btnTopic.addEventListener('click', ()=>{
  mode='topic';
  btnTopic.classList.add('active'); btnSearch.classList.remove('active');
  statusBadge.textContent = 'ãƒ¢ãƒ¼ãƒ‰: ãŠé¡Œæ’®å½±ï¼ˆtopicï¼‰';
});
btnSearch.addEventListener('click', ()=>{
  mode='search';
  btnSearch.classList.add('active'); btnTopic.classList.remove('active');
  statusBadge.textContent = 'ãƒ¢ãƒ¼ãƒ‰: ã‚«ãƒ¼ãƒ‰æ¢ç´¢ï¼ˆsearchï¼‰';
});
btnReset.addEventListener('click', ()=>{
  topics = []; numberMap = {};
  updateTopicsUI(); updateCandidatesUI();
  statusBadge.textContent = 'ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼ˆå¾…æ©Ÿä¸­ï¼‰';
});

/* init default mode */
btnTopic.classList.add('active');

/* =========================
   cleanup on unload
   ========================= */
window.addEventListener('beforeunload', async ()=>{
  if(worker) {
    try{ await worker.terminate(); }catch(e){}
  }
  const tracks = video.srcObject ? (video.srcObject.getTracks ? video.srcObject.getTracks() : []) : [];
  tracks.forEach(t=>t.stop && t.stop());
});
</script>
</body>
</html>
