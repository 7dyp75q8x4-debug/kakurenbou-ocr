<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã‹ãã‚Œã‚“ã¼OCR â€” æ–°UIç‰ˆ</title>

<style>
  :root{
    --ui-width: 58vw;      /* ğŸ”¥ æƒ…å ±ã‚¨ãƒªã‚¢ã‚’æœ€å¤§åŒ– */
    --cam-width: 42vw;     /* ğŸ”¥ ã‚«ãƒ¡ãƒ©ã‚’å°ã•ã */
    --btn-size: 64px;      /* ğŸ”¥ å°ã•ãªæ­£æ–¹å½¢ãƒœã‚¿ãƒ³ */
    --accent: #1e3cff;
  }

  html,body{
    margin:0; padding:0; background:#000; color:#fff;
    font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
    height:100%;
  }

  /* ğŸ“· ã‚«ãƒ¡ãƒ©é ˜åŸŸï¼ˆå·¦ï¼‰ */
  #cameraWrap{
    position:fixed; left:0; top:0;
    width:var(--cam-width); height:100vh;
    background:#000; display:flex; align-items:center; justify-content:center;
    overflow:hidden;
  }
  #camera{
    width:100%; height:100%; object-fit:cover;
  }

  /* ğŸ“Š UI ã‚¨ãƒªã‚¢ï¼ˆå³ï¼‰ */
  #ui{
    position:fixed; right:0; top:0;
    width:var(--ui-width); height:100vh;
    background:#111; padding:12px;
    display:flex; flex-direction:column;
    box-sizing:border-box;
  }

  /* ğŸŸ¦ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼ˆå¤§ããï¼‰ */
  #status{
    text-align:center;
    font-size:22px; font-weight:700;
    padding:14px 0;
    border-radius:10px;
    background:#1e3cff;
    margin-bottom:12px;
  }

  /* ğŸ”² æ­£æ–¹å½¢ãƒœã‚¿ãƒ³ */
  #btnArea{
    display:flex; gap:12px;
    flex-wrap:wrap;
    justify-content:flex-start;
  }
  .sqBtn{
    width:var(--btn-size); height:var(--btn-size);
    background:#333;
    border-radius:12px;
    font-size:26px;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
    border:2px solid #000;
  }
  .sqBtn:active{
    filter:brightness(1.2);
    transform:scale(0.96);
  }
  #shootBtn{
    background:#b11;
  }

  /* ğŸ“‹ æƒ…å ±ãƒ‘ãƒãƒ«ï¼ˆç”»é¢ã§ä¸€ç•ªå¤§ãã„éƒ¨åˆ†ï¼‰ */
  #infoPanel{
    margin-top:16px;
    background:#000;
    border-radius:12px;
    padding:16px;
    flex:1;
    overflow:auto;
    box-shadow:inset 0 0 12px rgba(255,255,255,0.06);
  }

  .title{
    font-size:20px;
    margin-bottom:8px;
    font-weight:700;
  }
  .bigBox{
    background:#222;
    border-radius:10px;
    padding:14px;
    font-size:22px;
    font-weight:600;
    line-height:1.5;
    margin-bottom:16px;
  }

</style>
</head>
<body>

<!-- å·¦ï¼šã‚«ãƒ¡ãƒ© -->
<div id="cameraWrap">
  <video id="camera" autoplay playsinline muted></video>
</div>

<!-- å³ï¼šUI -->
<div id="ui">

  <!-- ğŸ”¥ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
  <div id="status">ğŸŸ¦ å¾…æ©Ÿä¸­</div>

  <!-- ğŸ”² å°ã•ãªæ­£æ–¹å½¢ãƒœã‚¿ãƒ³ç¾¤ -->
  <div id="btnArea">
    <div id="btnTopic" class="sqBtn">ğŸ“¸</div>
    <div id="btnSearch" class="sqBtn">ğŸ”</div>
    <div id="btnTest" class="sqBtn">â™»ï¸</div>
    <div id="shootBtn" class="sqBtn">â—</div>
  </div>

  <!-- ğŸ“Š é‡è¦æƒ…å ±ãƒ‘ãƒãƒ« -->
  <div id="infoPanel">

    <div class="title">ãŠé¡Œï¼ˆ3æ¡ï¼‰ï¼š</div>
    <div id="topics" class="bigBox">â€”</div>

    <div class="title">å€™è£œ TOP3ï¼š</div>
    <div id="candidates" class="bigBox">â€”</div>

  </div>

</div>

<script>
/* -------------------------------------
   ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼ˆiOSã«æœ€é©åŒ–ï¼‰
------------------------------------- */
const video = document.getElementById("camera");
let stream = null;

async function startCamera(){
  try{
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
    }
    stream = await navigator.mediaDevices.getUserMedia({
      video:{
        facingMode:{ ideal:"environment" },
        width:{ ideal:1280 }
      },
      audio:false
    });
    video.srcObject = stream;
  }catch(e){
    alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—");
  }
}
startCamera();

/* -------------------------------------
   ğŸ”§ çŠ¶æ…‹
------------------------------------- */
let mode = "topic";
let isHolding = false;
let timer = null;
let topics = [];
let candidateCounts = {};

/* -------------------------------------
   ğŸ“› ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
------------------------------------- */
const statusEl = document.getElementById("status");
function setStatus(t, color="blue"){
  statusEl.textContent = t;
  statusEl.style.background = (color==="red" ? "#c11" : "#1e3cff");
}

/* -------------------------------------
   ğŸ”˜ ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
------------------------------------- */
document.getElementById("btnTopic").onclick = ()=>{ mode="topic"; setStatus("ğŸŸ¦ ãŠé¡Œæ’®å½±", "blue"); };
document.getElementById("btnSearch").onclick = ()=>{ mode="search"; setStatus("ğŸŸ¦ ã‚«ãƒ¼ãƒ‰æ¢ç´¢", "blue"); };
document.getElementById("btnTest").onclick = ()=>{ startCamera(); setStatus("ğŸŸ¦ ã‚«ãƒ¡ãƒ©å†èµ·å‹•", "blue"); };

/* -------------------------------------
   ğŸ“¸ é•·æŠ¼ã—æ’®å½±
------------------------------------- */
const shootBtn = document.getElementById("shootBtn");

shootBtn.addEventListener("mousedown", holdStart);
shootBtn.addEventListener("touchstart", holdStart);
shootBtn.addEventListener("mouseup", holdEnd);
shootBtn.addEventListener("mouseleave", holdEnd);
shootBtn.addEventListener("touchend", holdEnd);

function holdStart(e){
  e.preventDefault();
  if(isHolding) return;
  isHolding = true;
  setStatus("ğŸ”´ æ’®å½±ä¸­", "red");

  timer = setInterval(()=>captureAndProcess(), 800);
}

function holdEnd(e){
  e.preventDefault();
  if(!isHolding) return;
  isHolding = false;
  clearInterval(timer);
  setStatus("ğŸŸ¦ å¾…æ©Ÿä¸­", "blue");
}

/* -------------------------------------
   ğŸ“· ã‚­ãƒ£ãƒ—ãƒãƒ£ & OCRï¼ˆä»®ï¼‰
------------------------------------- */
function captureAndProcess(){
  if(!video.videoWidth) return;

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video,0,0);

  // ğŸ”¥ æœ¬ç•ªã¯ OCR ã‚’ã“ã“ã§å®Ÿè¡Œ
  const num = random3Digit(); // ä»®
  handleResult(num);
}

/* ä»®ã®3æ¡æ•°ï¼ˆæœ¬ç•ªã¯OCRï¼‰ */
function random3Digit(){
  return String(Math.floor(Math.random()*900)+100);
}

/* -------------------------------------
   ğŸ§  çµæœå‡¦ç†
------------------------------------- */
function handleResult(n){
  if(!/^\d{3}$/.test(n)) return;

  if(mode === "topic"){
    if(!topics.includes(n)) topics.push(n);
  }else{
    candidateCounts[n] = (candidateCounts[n]||0)+1;
  }

  updateInfo();
}

/* -------------------------------------
   ğŸ“Š UIæ›´æ–°
------------------------------------- */
function updateInfo(){
  document.getElementById("topics").textContent =
    topics.length ? topics.join(" / ") : "â€”";

  const arr = Object.keys(candidateCounts)
    .sort((a,b)=>candidateCounts[b]-candidateCounts[a])
    .slice(0,3);

  document.getElementById("candidates").innerHTML =
    arr.length ? arr.map((x,i)=>`${i+1}ä½ï¼š${x}`).join("\n") : "â€”";
}
</script>

</body>
</html>
