<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‹ãã‚Œã‚“ã¼OCR â€“ æ¨ªç”»é¢ç‰ˆ</title>
<style>
    body {
        margin: 0;
        background: #000;
        overflow: hidden;
    }

    /* æ¨ªç”»é¢ã§å‹•ç”»ãŒå¤§ããè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã« */
    #cameraArea {
        width: 100vw;
        height: 80vh;
        background: black;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }

    video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: none; /* ãƒŸãƒ©ãƒ¼è§£é™¤ */
    }

    /* ä¸‹ã«æ“ä½œãƒ‘ãƒãƒ«ã‚’æ¨ªä¸¦ã³ã§é…ç½® */
    #controlArea {
        width: 100vw;
        height: 20vh;
        background: #222;
        display: flex;
        flex-direction: row;
        justify-content: space-around;
        align-items: center;
        padding: 10px;
    }

    button {
        font-size: 2vw;
        padding: 10px 20px;
        border-radius: 10px;
        border: none;
        background: #444;
        color: white;
    }

    #modeDisplay {
        color: white;
        font-size: 2vw;
    }

    #progress {
        color: #0f0;
        font-size: 1.8vw;
    }
</style>
</head>
<body>

<div id="cameraArea">
    <video id="video" autoplay playsinline></video>
</div>

<div id="controlArea">
    <button onclick="setMode('odai')">ğŸ“¸ ãŠé¡Œãƒ¢ãƒ¼ãƒ‰</button>
    <button onclick="setMode('search')">ğŸ” æ¢ç´¢ãƒ¢ãƒ¼ãƒ‰</button>
    <button onclick="setMode('cameraTest')">ğŸ¥ ãƒ†ã‚¹ãƒˆ</button>

    <button id="captureBtn">ğŸ”´ é•·æŠ¼ã—æ’®å½±</button>

    <div>
        <div id="modeDisplay">ç¾åœ¨ï¼šãŠé¡Œãƒ¢ãƒ¼ãƒ‰</div>
        <div id="progress">å¾…æ©Ÿä¸­</div>
    </div>
</div>

<script>
let mode = "odai";
let stream = null;

let capturing = false;
let holdTimer = null;
let intervalId = null;
let capturedImages = [];

/* ============================
   ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
============================ */
function setMode(m) {
    mode = m;

    const text = {
        "odai": "ç¾åœ¨ï¼šãŠé¡Œãƒ¢ãƒ¼ãƒ‰",
        "search": "ç¾åœ¨ï¼šæ¢ç´¢ãƒ¢ãƒ¼ãƒ‰",
        "cameraTest": "ç¾åœ¨ï¼šã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰"
    };

    document.getElementById("modeDisplay").innerText = text[m];
}

/* ============================
   å¤–ã‚«ãƒ¡ãƒ©èµ·å‹•
============================ */
async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: { exact: "environment" },
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            }
        });
    } catch (e) {
        stream = await navigator.mediaDevices.getUserMedia({
            video: true
        });
    }
    document.getElementById("video").srcObject = stream;
}
startCamera();

/* ============================
   é•·æŠ¼ã—æ’®å½±å‡¦ç†
============================ */

const btn = document.getElementById("captureBtn");

function startHold() {
    if (capturing) return;

    holdTimer = setTimeout(() => {
        capturing = true;
        capturedImages = [];
        document.getElementById("progress").innerText = "æ’®å½±ä¸­â€¦ 0/10";

        intervalId = setInterval(() => {
            if (capturedImages.length >= 10) {
                stopCapture();
                return;
            }
            takePicture();
        }, 1000);
    }, 500);
}

function stopHold() {
    clearTimeout(holdTimer);
    if (capturing) stopCapture();
}

function stopCapture() {
    capturing = false;
    clearInterval(intervalId);
    document.getElementById("progress").innerText =
        `æ’®å½±çµ‚äº†ï¼š${capturedImages.length}æš`;
}

function takePicture() {
    const video = document.getElementById("video");
    const canvas = document.createElement("canvas");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    const data = canvas.toDataURL("image/png");
    capturedImages.push(data);

    document.getElementById("progress").innerText =
        `æ’®å½±ä¸­â€¦ ${capturedImages.length}/10`;
}

btn.addEventListener("mousedown", startHold);
btn.addEventListener("mouseup", stopHold);
btn.addEventListener("mouseleave", stopHold);

btn.addEventListener("touchstart", startHold);
btn.addEventListener("touchend", stopHold);
</script>
</body>
</html>
