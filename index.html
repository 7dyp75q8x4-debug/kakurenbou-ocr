<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>3桁数字カメラ検索</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.0/dist/tesseract.min.js"></script>
<style>
  body { font-family: sans-serif; text-align:center; margin:20px; }
  video { width: 320px; height: 240px; border: 1px solid #333; }
  #result { font-size: 22px; margin-top: 20px; }
</style>
</head>
<body>

<h1>3桁数字カメラ検索</h1>

<p>検索したい3桁の数字（スペース区切りで最大5個）</p>
<input id="targets" type="text" placeholder="例: 123 456 789" style="width:250px; font-size:16px;">
<br><br>

<video id="camera" autoplay playsinline></video>

<div id="result">検出待ち...</div>

<script>
(async () => {
  const video = document.getElementById("camera");
  const result = document.getElementById("result");

  // --- カメラ起動（背面カメラ固定） ---
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } }
    });
    video.srcObject = stream;
  } catch (err) {
    // exact で失敗した場合のフォールバック
    const stream2 = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });
    video.srcObject = stream2;
  }

  // Canvas（OCR 用）
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  async function scanFrame() {
    if (video.videoWidth === 0) {
      requestAnimationFrame(scanFrame);
      return;
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    // 入力した検索数字
    const targets = document.getElementById("targets").value
      .trim()
      .split(/\s+/)
      .filter(t => /^\d{3}$/.test(t)); // 3桁のみ

    if (targets.length === 0) {
      result.innerText = "3桁の数字を入力してください";
      requestAnimationFrame(scanFrame);
      return;
    }

    // OCR 読み取り
    const { data: { text } } = await Tesseract.recognize(canvas, 'eng');

    // 認識テキストから 3桁数字抽出
    const found = text.match(/\b\d{3}\b/g) || [];

    // ターゲットと一致
    const matches = found.filter(n => targets.includes(n));

    if (matches.length > 0) {
      result.innerHTML = `<b>一致:</b> ${matches.join(", ")}`;
    } else {
      result.innerText = "一致なし";
    }

    requestAnimationFrame(scanFrame);
  }

  scanFrame();
})();
</script>

</body>
</html>
