<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>かくれんぼ OCR Finder</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    background: #111;
    color: #fff;
    text-align: center;
    font-family: sans-serif;
}
button {
    font-size: 22px;
    padding: 15px 30px;
    margin: 10px;
    border-radius: 10px;
}
#video {
    width: 90%;
    border: 2px solid #fff;
}
#result {
    margin-top: 20px;
    font-size: 26px;
    font-weight: bold;
    white-space: pre-wrap;
}
</style>

<!-- ⭐ Tesseract.js v5（最新版） -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

</head>
<body>

<h1>かくれんぼ OCR Finder<br>(GitHub Pages版)</h1>

<button onclick="startCamera()">カメラを起動</button>
<button onclick="stopCamera()">停止</button>

<br><br>

<video id="video" autoplay playsinline></video>

<div id="result">（ここに認識結果が表示されます）</div>

<script>
const video = document.getElementById("video");
let stream;
let ocrRunning = false;

/* --- カメラ起動 --- */
async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }
        });
        video.srcObject = stream;

        startOCR();
    } catch (e) {
        alert("カメラが起動できません。\nHTTPS で開いているか確認してください。\n\n詳細:\n" + e);
    }
}

/* --- カメラ停止 --- */
function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
    }
    ocrRunning = false;
}

/* --- OCR 開始 --- */
async function startOCR() {
    if (ocrRunning) return;
    ocrRunning = true;

    const worker = await Tesseract.createWorker();  // ★ v5 の正しい初期化

    await worker.loadLanguage('eng');
    await worker.initialize('eng');

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    async function loop() {
        if (!ocrRunning) {
            await worker.terminate();
            return;
        }

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        const { data: { text } } = await worker.recognize(canvas);

        document.getElementById("result").textContent = text;

        requestAnimationFrame(loop);
    }

    loop();
}
</script>

</body>
</html>
