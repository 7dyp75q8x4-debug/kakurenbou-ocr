<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Kakurenbo OCR横画面版</title>

<style>
    body {
        margin: 0;
        overflow: hidden;
        background: #000;
        color: white;
        font-family: sans-serif;
        display: flex;
        flex-direction: row;
        height: 100vh;
    }

    /* 左側：カメラ映像エリア */
    #cameraArea {
        flex: 3;
        background: black;
        position: relative;
    }

    video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: rotate(0deg);
    }

    /* 右側：操作エリア */
    #uiArea {
        flex: 1;
        background: rgba(20,20,20,0.95);
        display: flex;
        flex-direction: column;
        padding: 10px;
        box-sizing: border-box;
    }

    button {
        width: 100%;
        padding: 15px;
        margin-bottom: 15px;
        font-size: 18px;
        border: none;
        border-radius: 8px;
        background: #333;
        color: #fff;
    }
    button:active {
        background: #666;
    }

    #statusBox {
        margin-top: 20px;
        font-size: 20px;
        line-height: 1.6;
        white-space: pre-line;
    }
</style>
</head>

<body>
    <div id="cameraArea">
        <video id="video" autoplay playsinline></video>
    </div>

    <div id="uiArea">
        <button id="modeOdaBtn">お題読み取りモード</button>
        <button id="modeCardBtn">カード探索モード</button>
        <button id="shootBtn">長押しで撮影</button>

        <div id="statusBox">
            モード：待機中
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

<script>
/* -----------------------------------------
    変数
----------------------------------------- */
let currentMode = "none"; // "oda" or "card"
let isHolding = false;
let captureCount = 0;
const maxCaptures = 10;
let stream = null;
let video = document.getElementById("video");
let statusBox = document.getElementById("statusBox");

let odaList = []; // お題で抽出した3桁数字リスト

/* -----------------------------------------
    カメラ起動（外カメラ）
----------------------------------------- */
async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { exact: "environment" } },
            audio: false
        });
    } catch (e) {
        // 外カメラがダメな場合 内カメラ fallback
        stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: false
        });
    }
    video.srcObject = stream;
}

startCamera();

/* -----------------------------------------
    モード変更
----------------------------------------- */
document.getElementById("modeOdaBtn").onclick = () => {
    currentMode = "oda";
    statusBox.textContent = "モード：お題読み取り\n待機中";
};

document.getElementById("modeCardBtn").onclick = () => {
    currentMode = "card";
    statusBox.textContent = "モード：カード探索\n待機中";
};

/* -----------------------------------------
    長押し撮影
----------------------------------------- */
const shootBtn = document.getElementById("shootBtn");

shootBtn.addEventListener("mousedown", startLongPress);
shootBtn.addEventListener("touchstart", startLongPress);

shootBtn.addEventListener("mouseup", stopLongPress);
shootBtn.addEventListener("mouseleave", stopLongPress);
shootBtn.addEventListener("touchend", stopLongPress);

function startLongPress(e) {
    e.preventDefault();
    if (isHolding) return;
    isHolding = true;
    captureCount = 0;

    statusBox.textContent = `モード：${currentMode === "oda" ? "お題読み取り" : "カード探索"}\n撮影開始`;
    shootLoop();
}

function stopLongPress() {
    isHolding = false;
    statusBox.textContent += `\n撮影停止`;
}

/* -----------------------------------------
    1秒ごとの連写
----------------------------------------- */
async function shootLoop() {
    if (!isHolding) return;

    if (captureCount >= maxCaptures) {
        statusBox.textContent += `\n最大${maxCaptures}枚で停止`;
        isHolding = false;
        return;
    }

    captureCount++;

    const percent = Math.floor((captureCount / maxCaptures) * 100);

    statusBox.textContent = 
        `モード：${currentMode === "oda" ? "お題読み取り" : "カード探索"}\n` +
        `撮影中… ${captureCount}/${maxCaptures} (${percent}%)`;

    await analyzeFrame();

    setTimeout(shootLoop, 1000);
}

/* -----------------------------------------
    OCR処理
----------------------------------------- */
async function analyzeFrame() {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    let dataUrl = canvas.toDataURL("image/png");

    const result = await Tesseract.recognize(dataUrl, "eng", {
        tessedit_char_whitelist: "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"
    });

    let text = result.data.text.replace(/\s+/g, "");

    if (currentMode === "oda") {
        // 3桁数字だけ抽出
        let nums = text.match(/\d{3}/g);
        if (nums) {
            odaList = nums;
            statusBox.textContent += `\nお題更新：${JSON.stringify(odaList)}`;
        }
    }

    if (currentMode === "card") {
        // 3桁数字＋1文字アルファベット
        let pairs = text.match(/\d{3}[A-Z]/g);
        if (!pairs) return;

        let found = [];
        for (let p of pairs) {
            let num = p.slice(0, 3);
            let alpha = p.slice(3);
            if (odaList.includes(num)) {
                found.push(`${num} → ${alpha}`);
            }
        }

        if (found.length > 0) {
            statusBox.textContent += "\n" + found.join("\n");
        }
    }
}
</script>
</body>
</html>
