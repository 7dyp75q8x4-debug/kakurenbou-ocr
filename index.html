<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>3桁数字カメラ検索（外カメラ固定・連写対応）</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.0/dist/tesseract.min.js"></script>
<style>
  body { font-family: sans-serif; text-align:center; margin:20px; }
  video { width: 320px; height: 240px; border: 1px solid #333; display:block; margin: 0 auto; }
  #controls { margin-top: 12px; }

  /* 撮影ボタン（画像ボタン） */
  #captureBtn {
    padding: 0;
    border: none;
    background: none;
    user-select: none;
    -webkit-user-select: none;
  }
  #captureBtn img {
    width: 70px;
    height: 70px;
    pointer-events: none;
  }

  #status { margin-top:10px; font-weight:bold; height:24px; }
  #result { font-size: 20px; margin-top: 12px; }
  input#targets { width:250px; font-size:16px; padding:6px; }
</style>
</head>
<body>

<h1>3桁数字カメラ検索</h1>

<p>検索したい3桁の数字（スペース区切りで最大5個）</p>
<input id="targets" type="text" placeholder="例: 123 456 789">

<div id="controls">
  <button id="captureBtn" type="button">
    <!-- ボタン画像（シンプルなカメラアイコン SVG） -->
    <img src="data:image/svg+xml;utf8,
      <svg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 24 24' fill='black'>
        <path d='M12 5c-3.86 0-7 3.14-7 7s3.14 7 7 7
        7-3.14 7-7-3.14-7-7-7zm0 12c-2.76 0-5-2.24-5-5
        s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z'/>
        <circle cx='12' cy='12' r='2.5'/>
        <path d='M20 4h-3.17l-1.84-2H8.99L7.15 4H4
        c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16
        c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2z'/>
      </svg>" />
  </button>
  <div id="status"></div>
</div>

<video id="camera" autoplay playsinline></video>

<div id="result">検出待ち...</div>

<script>
(async () => {

  const video = document.getElementById("camera");
  const result = document.getElementById("result");
  const status = document.getElementById("status");
  const captureBtn = document.getElementById("captureBtn");

  /*==================================================
      1. カメラ（外カメラ固定）修正版
  ==================================================*/
  async function startCamera() {

    // まず普通に environment を要求（iPhone Safariで最も成功率が高い）
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false
      });
      video.srcObject = stream;
      return;
    } catch(e) {
      console.warn("facingMode environment 失敗。fallback 開始");
    }

    // Fallback: デバイス一覧から背面候補を探す
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === "videoinput");

    let backCam = cams.find(d =>
      d.label.toLowerCase().includes("back") ||
      d.label.toLowerCase().includes("rear") ||
      d.label.toLowerCase().includes("environment")
    );

    // ラベル未取得の場合（iPhone初回）はとりあえず cams[0] 使用
    if (!backCam) backCam = cams[0];

    const stream2 = await navigator.mediaDevices.getUserMedia({
      video: { deviceId: backCam.deviceId },
      audio: false
    });

    video.srcObject = stream2;
  }

  await startCamera();

  /*==================================================
      2. OCR 用の処理（前回と同じ）
  ==================================================*/
  const captureCanvas = document.createElement("canvas");
  const captureCtx = captureCanvas.getContext("2d");

  function captureFrame() {
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    captureCanvas.width = vw;
    captureCanvas.height = vh;
    captureCtx.drawImage(video, 0, 0, vw, vh);
    return captureCanvas;
  }

  function getTargets(){
    return document.getElementById("targets").value
      .trim().split(/\s+/)
      .filter(v => /^\d{3}$/.test(v));
  }

  async function doOCR(canvas) {
    const { data: { text }} =
      await Tesseract.recognize(canvas, 'eng', {
        tessedit_char_whitelist: '0123456789',
        psm: '7'
      });
    return text || "";
  }

  let ocrInProgress = false;
  async function shootAndOcr(){
    if (ocrInProgress) return;
    ocrInProgress = true;

    const targets = getTargets();
    if (targets.length === 0){
      result.innerText = "3桁数字を入力してください";
      ocrInProgress = false;
      return;
    }

    const canvas = captureFrame();
    const text = await doOCR(canvas);

    const found = (text.match(/\d{3}/g) || []);
    const hits = found.filter(n => targets.includes(n));

    if (hits.length){
      result.innerHTML = `<b>一致:</b> ${[...new Set(hits)].join(", ")}`;
    } else {
      result.innerText = "一致なし";
    }

    ocrInProgress = false;
  }


  /*==================================================
      3. 長押しで連写（撮影中ステータス表示）
  ==================================================*/
  let burstTimer = null;
  const burstInterval = 600;

  function startBurst() {
    if (burstTimer) return;
    status.textContent = "撮影中";

    shootAndOcr();  // 最初の1枚
    burstTimer = setInterval(shootAndOcr, burstInterval);
  }

  function stopBurst() {
    if (burstTimer){
      clearInterval(burstTimer);
      burstTimer = null;
    }
    status.textContent = "";
  }

  // マウス
  captureBtn.addEventListener("mousedown", e => { e.preventDefault(); startBurst(); });
  document.addEventListener("mouseup", stopBurst);

  // タッチ
  captureBtn.addEventListener("touchstart", e => { e.preventDefault(); startBurst(); });
  document.addEventListener("touchend", stopBurst);

  // 単発撮影（短押し）
  captureBtn.addEventListener("click", e => {
    if (!burstTimer){
      status.textContent = "撮影中";
      shootAndOcr().finally(()=>{ status.textContent=""; });
    }
  });

})();
</script>

</body>
</html>
