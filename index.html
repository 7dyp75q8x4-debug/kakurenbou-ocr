<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>かくれんぼ OCR — カメラ確認版</title>
<style>
  :root{
    --bg:#060607;
    --panel:#0f0f10;
    --muted:#9aa0a6;
    --accent:#1e90ff;
    --alert:#e03b3b;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif; overflow:hidden;}
  .app {
    display:grid;
    grid-template-columns: 1fr 360px;
    gap:12px;
    height:100vh;
    padding:12px;
    box-sizing:border-box;
    align-items:start;
  }

  .left {
    display:flex;
    flex-direction:column;
    gap:12px;
    padding:6px;
    box-sizing:border-box;
  }
  .odai-row {
    display:grid;
    grid-template-columns: 84px 1fr 1fr 1fr;
    gap:10px;
    align-items:center;
    background:linear-gradient(180deg,#0b0b0d,#0a0a0c);
    padding:8px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.03);
    min-height:88px;
  }
  .odai-label {
    writing-mode:vertical-rl;
    transform:rotate(180deg);
    font-weight:800;
    font-size:18px;
    text-align:center;
    color:#fff;
  }
  .cand-box {
    width:100%;
    height:72px;
    background:#0f0f10;
    border-radius:8px;
    border:1px solid #222;
    display:flex;
    align-items:center;
    justify-content:center;
    color:var(--muted);
    font-weight:700;
    font-size:14px;
    overflow:hidden;
  }
  .cand-img {
    width:100%; height:100%; object-fit:cover;
  }

  .right {
    display:flex;
    flex-direction:column;
    gap:10px;
    padding:6px;
    box-sizing:border-box;
  }
  .status {
    background:#0b0b0b;
    border-radius:8px;
    padding:10px;
    text-align:center;
    font-weight:800;
    color:var(--accent);
    border:1px solid #111;
  }
  .controls {
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }
  .btn {
    background:#161617;
    color:#fff;
    border-radius:8px;
    padding:10px 12px;
    border:1px solid #222;
    cursor:pointer;
    font-weight:800;
    min-width:112px;
    text-align:center;
  }
  .btn.small {
    min-width:56px;
    padding:8px;
    height:48px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
  }
  .btn.alert { background:var(--alert); }

  .camera-box {
    background:#0b0b0b;
    border-radius:8px;
    padding:8px;
    border:1px solid #222;
    display:flex;
    flex-direction:column;
    gap:8px;
    align-items:stretch;
  }

  video#preview {
    width:100%;
    height:220px;
    background:#000;
    object-fit:cover;
    border-radius:6px;
    border:1px solid #111;
  }

  .meta-row {
    display:flex;
    justify-content:space-between;
    gap:8px;
    color:var(--muted);
    font-size:13px;
  }

  .log {
    background:rgba(0,0,0,0.45);
    border-radius:8px;
    padding:8px;
    font-family:monospace;
    font-size:12px;
    max-height:200px;
    overflow:auto;
    color:#fff;
  }

  @media (max-width:900px){
    .app { grid-template-columns:1fr 320px; gap:8px; padding:8px; }
    video#preview { height:180px; }
  }
</style>
</head>
<body>
<div class="app">

  <!-- LEFT SIDE -->
  <div class="left">
    <div class="odai-row"><div class="odai-label">お題1</div><div class="cand-box" id="odaiThumbSlot0">未セット</div><div class="cand-box">候補 1</div><div class="cand-box">候補 2</div></div>
    <div class="odai-row"><div class="odai-label">お題2</div><div class="cand-box" id="odaiThumbSlot1">未セット</div><div class="cand-box">候補 1</div><div class="cand-box">候補 2</div></div>
    <div class="odai-row"><div class="odai-label">お題3</div><div class="cand-box" id="odaiThumbSlot2">未セット</div><div class="cand-box">候補 1</div><div class="cand-box">候補 2</div></div>
    <div class="odai-row"><div class="odai-label">お題4</div><div class="cand-box" id="odaiThumbSlot3">未セット</div><div class="cand-box">候補 1</div><div class="cand-box">候補 2</div></div>
    <div class="odai-row"><div class="odai-label">お題5</div><div class="cand-box" id="odaiThumbSlot4">未セット</div><div class="cand-box">候補 1</div><div class="cand-box">候補 2</div></div>
  </div>

  <!-- RIGHT SIDE -->
  <div class="right">
    <div class="status">状態：<span id="statusText">待機中</span></div>

    <div class="controls">
      <div class="btn" id="btnModeOdai">お題撮影モード</div>
      <div class="btn" id="btnModeSearch">番号検索モード</div>
      <div class="btn small" id="btnReset">リセット</div>
      <div class="btn small alert" id="btnLong">●</div>
    </div>

    <div class="camera-box">
      <video id="preview" autoplay playsinline muted></video>
      <div class="meta-row">
        <div>撮影枚数: <span id="frames">0</span></div>
        <div id="modeLabel">モード: お題撮影</div>
      </div>
      <div class="log" id="log">ログ: (ここにメッセージが表示されます)</div>
    </div>
  </div>

</div>

<script>
const preview = document.getElementById("preview");
const logEl = document.getElementById("log");
const frames = document.getElementById("frames");
const statusText = document.getElementById("statusText");
const btnModeOdai = document.getElementById("btnModeOdai");
const btnModeSearch = document.getElementById("btnModeSearch");
const btnLong = document.getElementById("btnLong");
const btnReset = document.getElementById("btnReset");
const modeLabel = document.getElementById("modeLabel");

let mode = "odai";
let capturing = false;
let timer = null;
let count = 0;

function log(msg){
  const t = new Date().toLocaleTimeString();
  logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
}

async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:"environment"}, width:{ideal:1280}, height:{ideal:720}},
      audio:false
    });
    preview.srcObject = stream;
    await preview.play();
    log("カメラ起動");
  }catch(err){
    log("カメラ起動エラー: "+err.message);
    alert("カメラ起動に失敗しました。HTTPSか権限を確認してください。");
  }
}

btnModeOdai.onclick = ()=>{
  mode = "odai";
  modeLabel.textContent = "モード: お題撮影";
  log("モード切替: お題撮影モード");
};

btnModeSearch.onclick = ()=>{
  mode = "search";
  modeLabel.textContent = "モード: 番号検索モード";
  log("モード切替: 番号検索モード");
};

btnReset.onclick = ()=>{
  for(let i=0;i<5;i++){
    const box = document.getElementById("odaiThumbSlot"+i);
    box.textContent = "未セット";
    box.style.backgroundImage = "";
  }
  log("リセット");
};

btnLong.onpointerdown = ()=>{
  if(capturing) return;
  capturing = true;
  statusText.textContent = "撮影中";
  log("読み取り開始");
  count = 0;
  timer = setInterval(()=>{
    count++;
    frames.textContent = count;
    log("フレーム取得 "+count);
    if(count >= 10){
      stop();
    }
  }, 1000);
};

document.onpointerup = stop;

function stop(){
  if(!capturing) return;
  capturing = false;
  statusText.textContent = "待機中";
  clearInterval(timer);
  log("読み取り終了");
}

startCamera();
</script>

</body>
</html>
