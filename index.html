<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OCR UI Fixed</title>

<style>
  body{
    margin:0; padding:0; background:#000; color:#fff;
    font-family: -apple-system, system-ui;
  }

  /* â˜… ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯ç¸¦ä¸€åˆ—ã«å…¨éƒ¨åã‚ã‚‹ */
  #wrap{
    display:flex;
    flex-direction:column;
    width:100vw;
    height:100vh;
    padding:10px;
    gap:10px;
    box-sizing:border-box;
  }

  /* ğŸ”¥ ã‚«ãƒ¡ãƒ©ã¯å°ã•ã‚ï¼ˆSafari ã®é»’ç”»é¢å¯¾ç­–ã§æœ€å° 140px ä»¥ä¸Šï¼‰ */
  #cameraBox{
    width:160px;
    height:120px;
    background:#111;
    border:2px solid #333;
    border-radius:10px;
    overflow:hidden;
    position:relative;
  }

  #camera{
    width:100%;
    height:100%;
    object-fit:cover;
    background:#000;
  }

  /* ğŸ”¥ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ï¼ˆå¤§ããç›®ç«‹ã¤ï¼‰ */
  #status{
    padding:10px;
    text-align:center;
    font-size:20px;
    font-weight:bold;
    background:#1e3cff;
    border-radius:10px;
  }

  /* ğŸ”² å°ã•ãªæ­£æ–¹å½¢ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
  #btnRow{
    display:flex;
    gap:10px;
  }

  .sqBtn{
    width:70px;
    height:70px;
    background:#333;
    border-radius:10px;
    font-size:28px;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  #shootBtn{ background:#b11; }

  /* ğŸ”¥ æƒ…å ±ãƒ‘ãƒãƒ«ï¼ˆå¤§ãããƒ»æœ€é‡è¦ï¼‰ */
  #infoPanel{
    flex:1;
    background:#111;
    border-radius:10px;
    padding:10px;
    overflow:auto;
  }

  .box{
    background:#222;
    padding:12px;
    border-radius:8px;
    margin-bottom:12px;
    font-size:22px;
    line-height:1.5em;
  }

</style>
</head>
<body>

<div id="wrap">

  <!-- â‘  ã‚«ãƒ¡ãƒ©ï¼ˆæ¥µå°OKã«ã—ãŸãŒé»’ç”»é¢å‡ºãªã„ã‚ˆã†æœ€ä½ã‚µã‚¤ã‚ºç¢ºä¿ï¼‰ -->
  <div id="cameraBox">
    <video id="camera" autoplay playsinline muted></video>
  </div>

  <!-- â‘¡ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
  <div id="status">ğŸŸ¦ å¾…æ©Ÿä¸­</div>

  <!-- â‘¢ ãƒœã‚¿ãƒ³ç¾¤ -->
  <div id="btnRow">
    <div id="btnTopic"  class="sqBtn">ğŸ“¸</div>
    <div id="btnSearch" class="sqBtn">ğŸ”</div>
    <div id="btnTest"   class="sqBtn">â™»ï¸</div>
    <div id="shootBtn"  class="sqBtn">â—</div>
  </div>

  <!-- â‘£ æƒ…å ±è¡¨ç¤º -->
  <div id="infoPanel">
    <div class="box" id="topicBox">ãŠé¡Œï¼šâ€”</div>
    <div class="box" id="candBox">å€™è£œTOP3ï¼šâ€”</div>
  </div>

</div>


<script>
/* ----------------------------------------
   ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼ˆiOS é»’ç”»é¢å¯¾ç­– ã™ã¹ã¦é©ç”¨ï¼‰
---------------------------------------- */
const video = document.getElementById("camera");
let stream = null;

async function startCamera(){
  try{
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
    }

    stream = await navigator.mediaDevices.getUserMedia({
      video:{
        facingMode:{ ideal:"environment" },
        width:{ ideal:640 },
        height:{ ideal:480 }
      },
      audio:false
    });

    /* iOS å†ç”Ÿå¯¾ç­–ï¼šæ˜ç¤ºçš„ã« play() ã™ã‚‹ */
    video.srcObject = stream;
    video.muted = true;
    video.setAttribute("playsinline", true);

    setTimeout(()=> video.play(), 200);

  }catch(e){
    alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—: " + e);
  }
}

startCamera(); // èµ·å‹•

/* ----------------------------------------
   ğŸ”§ çŠ¶æ…‹é–¢é€£
---------------------------------------- */
const s = id => document.getElementById(id);
let mode = "topic";
let topics = [];
let candidateCounts = {};
let holdTimer = null;
let holding = false;

function statusBlue(msg){
  s("status").textContent = msg;
  s("status").style.background = "#1e3cff";
}
function statusRed(msg){
  s("status").textContent = msg;
  s("status").style.background = "#b11";
}

/* ----------------------------------------
   ğŸ”˜ ãƒœã‚¿ãƒ³
---------------------------------------- */
s("btnTopic").onclick  = ()=>{ mode="topic";  statusBlue("ğŸ“¸ ãŠé¡Œæ’®å½±ãƒ¢ãƒ¼ãƒ‰"); };
s("btnSearch").onclick = ()=>{ mode="search"; statusBlue("ğŸ” ã‚«ãƒ¼ãƒ‰æ¢ç´¢ãƒ¢ãƒ¼ãƒ‰"); };
s("btnTest").onclick   = ()=>{ startCamera(); statusBlue("â™»ï¸ ã‚«ãƒ¡ãƒ©å†èµ·å‹•"); };

/* ----------------------------------------
   ğŸ“¸ é•·æŠ¼ã—æ’®å½±
---------------------------------------- */
const shootBtn = s("shootBtn");

shootBtn.addEventListener("mousedown", startHold);
shootBtn.addEventListener("touchstart", startHold);
shootBtn.addEventListener("mouseup", endHold);
shootBtn.addEventListener("mouseleave", endHold);
shootBtn.addEventListener("touchend", endHold);

function startHold(e){
  e.preventDefault();
  if(holding) return;
  holding = true;
  statusRed("â— æ’®å½±ä¸­");

  holdTimer = setInterval(()=> processFrame(), 700);
}

function endHold(e){
  e.preventDefault();
  holding = false;
  clearInterval(holdTimer);
  statusBlue("ğŸŸ¦ å¾…æ©Ÿä¸­");
}

/* ----------------------------------------
   ğŸ“· OCRå‡¦ç†ï¼ˆä»®ã§ãƒ©ãƒ³ãƒ€ãƒ 3æ¡ï¼‰
---------------------------------------- */
function processFrame(){
  if(!video.videoWidth) return;

  const num = String(100 + Math.floor(Math.random()*900));
  handleResult(num);
}

function handleResult(n){
  if(mode === "topic"){
    if(!topics.includes(n)) topics.push(n);
  }else{
    candidateCounts[n] = (candidateCounts[n] || 0) + 1;
  }
  updateUI();
}

/* ----------------------------------------
   ğŸ“Š UIæ›´æ–°
---------------------------------------- */
function updateUI(){
  s("topicBox").textContent = "ãŠé¡Œï¼š" + (topics.length ? topics.join(" / ") : "â€”");

  const top3 = Object.keys(candidateCounts)
    .sort((a,b)=>candidateCounts[b]-candidateCounts[a])
    .slice(0,3);

  s("candBox").textContent =
    "å€™è£œTOP3ï¼š" + (top3.length ? top3.join(" / ") : "â€”");
}
</script>

</body>
</html>
