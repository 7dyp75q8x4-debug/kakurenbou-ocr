//------------------------------------------------------------
// 要素取得
//------------------------------------------------------------
const video = document.getElementById("camera");
const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d");

let currentMode = "A";
let stream = null;

let answerHistory = new Set();


//------------------------------------------------------------
// 画面読み込み時：キーがなければ必ずモーダル表示
//------------------------------------------------------------
window.addEventListener("load", () => {

    const camKey = localStorage.getItem("camera_key");
    const ocrKey = localStorage.getItem("ocr_key");

    if (!camKey || !ocrKey) {
        showKeyModal();
    } else {
        startCamera();
    }
});


//------------------------------------------------------------
// モーダル開閉
//------------------------------------------------------------
function showKeyModal() {
    document.getElementById("key-modal").style.display = "flex";
}

function hideKeyModal() {
    document.getElementById("key-modal").style.display = "none";
}


//------------------------------------------------------------
// キー保存
//------------------------------------------------------------
document.getElementById("save-keys").addEventListener("click", () => {
    const cam = document.getElementById("camera-key").value.trim();
    const ocr = document.getElementById("ocr-key").value.trim();

    if (!cam || !ocr) {
        alert("APIキーを入力してください！");
        return;
    }

    localStorage.setItem("camera_key", cam);
    localStorage.setItem("ocr_key", ocr);

    hideKeyModal();
    startCamera();
});


//------------------------------------------------------------
// カメラ起動
//------------------------------------------------------------
async function startCamera() {
    try {
        const key = localStorage.getItem("camera_key");
        if (!key) {
            showKeyModal();
            return;
        }

        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }
        });

        video.srcObject = stream;
    } catch (err) {
        console.error("Camera error:", err);
    }
}


//------------------------------------------------------------
// 撮影
//------------------------------------------------------------
async function captureFrame() {
    if (!video.videoWidth) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    if (currentMode === "A") {
        await runAModeScan();
    } else {
        await runQModeScan();
    }
}


//------------------------------------------------------------
// ★ OCR API 呼び出し（ここが最重要）
//------------------------------------------------------------
async function callOCRApi(base64image) {
    const ocrKey = localStorage.getItem("ocr_key");
    if (!ocrKey) {
        showKeyModal();
        throw new Error("OCR APIキーがありません");
    }

    const response = await fetch(
        "https://vision.googleapis.com/v1/images:annotate?key=" + ocrKey,
        {
            method: "POST",
            body: JSON.stringify({
                requests: [
                    {
                        image: { content: base64image },
                        features: [{ type: "TEXT_DETECTION" }]
                    }
                ]
            })
        }
    );

    const json = await response.json();
    return json;
}


//------------------------------------------------------------
// detectThreeDigitNumbers：OCR 経由で検出
//------------------------------------------------------------
async function detectThreeDigitNumbers(bitmap) {

    // キー無しで絶対動かないようにする
    const ocrKey = localStorage.getItem("ocr_key");
    if (!ocrKey) {
        showKeyModal();
        return [];
    }

    const dataURL = bitmap.toDataURL("image/jpeg");
    const base64 = dataURL.replace(/^data:image\/jpeg;base64,/, "");

    const ocrResult = await callOCRApi(base64);

    // 必要な数字抽出（元のロジックに合わせて調整）
    return extractNumbersFromOCR(ocrResult);
}


//------------------------------------------------------------
// Qモード用 OCR も同じくキー必須
//------------------------------------------------------------
async function detectTargetForQuiz(bitmap) {
    const ocrKey = localStorage.getItem("ocr_key");
    if (!ocrKey) {
        showKeyModal();
        return null;
    }

    const dataURL = bitmap.toDataURL("image/jpeg");
    const base64 = dataURL.replace(/^data:image\/jpeg;base64,/, "");

    const ocrResult = await callOCRApi(base64);

    return extractQuizTarget(ocrResult);
}
