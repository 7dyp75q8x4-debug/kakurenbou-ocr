<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>かくれんぼ OCR — カメラ確認</title>
<style>
  :root{
    --bg:#070708;
    --panel:#0f1011;
    --muted:#9fa3a6;
    --white:#ffffff;
    --green:#2db34a;
    --red:#e03b3b;
    --slot:#0b0b0d;
    --rightW:360px; /* adjust if needed */
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--white);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif; overflow:hidden;}
  /* Top-level two columns: left = slots, right = controls */
  .app {
    display:grid;
    grid-template-columns: 1fr var(--rightW);
    gap:12px;
    height:100vh;
    padding:10px;
    box-sizing:border-box;
    align-items:start;
  }

  /* LEFT: rows 1..5, each row has 4 slots (a..d) */
  .left {
    background:linear-gradient(180deg,#0b0b0c,#0a0a0c);
    border-radius:12px;
    padding:10px;
    box-sizing:border-box;
    display:flex;
    flex-direction:column;
    gap:8px;
    height:100%;
    justify-content:flex-start;
    overflow:hidden;
  }

  .row {
    display:grid;
    grid-template-columns: 46px 1fr 1fr 1fr 1fr; /* label + a + b + c + d */
    gap:8px;
    align-items:center;
    min-height:64px;
  }
  .row-label {
    font-weight:900;
    font-size:18px;
    text-align:center;
    color:var(--white);
    padding-left:6px;
  }
  .slot {
    background:var(--slot);
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.03);
    height:60px;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    position:relative;
  }
  .slot img { width:100%; height:100%; object-fit:cover; display:block; }
  .slot .label { position:absolute; bottom:6px; left:6px; font-size:12px; color:var(--muted); background:rgba(0,0,0,0.28); padding:2px 6px; border-radius:6px; }

  /* RIGHT: controls + status + camera + log */
  .right {
    display:flex;
    flex-direction:column;
    gap:8px;
    height:100%;
    box-sizing:border-box;
  }

  .status {
    background:var(--panel);
    border-radius:10px;
    padding:10px;
    text-align:center;
    font-weight:900;
    border:1px solid rgba(255,255,255,0.03);
    color:var(--white);
  }
  .status .state { color:var(--white); font-weight:900; }

  .modes {
    display:flex;
    gap:8px;
    justify-content:space-between;
  }
  .btn {
    background:var(--white);
    color:#000;
    border-radius:12px;
    padding:8px 12px;
    font-weight:800;
    cursor:pointer;
    border:none;
    min-width:120px;
    text-align:center;
  }
  .btn.small { min-width:56px; padding:8px; border-radius:10px; }

  .btn.search-active { background:var(--green); color:#fff; }
  .btn.odai-active { background:var(--red); color:#fff; }

  .controls {
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:space-between;
  }

  .camera-box {
    background:var(--panel);
    border-radius:10px;
    padding:8px;
    border:1px solid rgba(255,255,255,0.03);
    display:flex;
    flex-direction:column;
    gap:8px;
    box-sizing:border-box;
    align-items:stretch;
  }
  video#preview {
    width:100%;
    height:220px;
    background:#000;
    border-radius:8px;
    object-fit:cover;
  }

  .log {
    background:rgba(0,0,0,0.45);
    border-radius:8px;
    padding:8px;
    font-family:monospace;
    font-size:12px;
    color:var(--white);
    height:130px;
    overflow:auto;
    border:1px solid rgba(255,255,255,0.03);
  }

  /* Fit into one screen: shrink if narrow */
  @media (max-width:900px){
    :root{ --rightW:300px; }
    .app { grid-template-columns: 1fr var(--rightW); padding:8px; gap:8px; }
    video#preview { height:180px; }
    .slot { height:56px; }
  }
  @media (max-width:640px){
    /* extremely narrow: still keep two columns but reduce sizes */
    .app { grid-template-columns: 1fr var(--rightW); }
    .row { grid-template-columns: 36px 1fr 1fr 1fr 1fr; }
    .row-label { font-size:16px; }
    .btn { min-width:100px; padding:6px 8px; }
  }
</style>
</head>
<body>
  <div class="app">
    <!-- LEFT -->
    <div class="left" id="leftPanel" aria-label="お題と候補">
      <!-- rows 1..5 generated by script -->
    </div>

    <!-- RIGHT -->
    <div class="right" id="rightPanel">
      <div class="status" id="statusBox">状態：<span id="statusState" class="state">待機中</span></div>

      <div class="modes">
        <button id="btnSearch" class="btn">探索モード</button>
        <button id="btnOdai" class="btn">お題モード</button>
      </div>

      <div class="controls">
        <div style="display:flex;gap:8px;">
          <button id="btnReset" class="btn small">リセット</button>
          <button id="btnRecord" class="btn small">●</button>
        </div>
        <div style="font-size:13px;color:var(--muted);">撮影枚数: <span id="framesCount">0</span></div>
      </div>

      <div class="camera-box" aria-label="カメラ映像">
        <video id="preview" autoplay playsinline muted></video>
      </div>

      <div class="log" id="logBox" aria-live="polite"></div>
    </div>
  </div>

<script>
/* UI setup: build left rows 1..5 with cols a..d (4 slots)
   slot id: slot-r{row}-c{col} where col 1=a,2=b,3=c,4=d
*/
const ROWS = 5, COLS = 4;
const leftPanel = document.getElementById('leftPanel');

for(let r=1;r<=ROWS;r++){
  const row = document.createElement('div');
  row.className = 'row';
  row.dataset.row = r;
  // label
  const lbl = document.createElement('div');
  lbl.className = 'row-label';
  lbl.textContent = r;
  row.appendChild(lbl);
  // slots a..d
  for(let c=1;c<=COLS;c++){
    const s = document.createElement('div');
    s.className = 'slot';
    s.id = `slot-r${r}-c${c}`;
    const lab = document.createElement('div');
    lab.className = 'label';
    if(c===1) lab.textContent = '未セット';
    else lab.textContent = `候補 ${c-1}`;
    s.appendChild(lab);
    row.appendChild(s);
  }
  leftPanel.appendChild(row);
}

/* Elements */
const btnSearch = document.getElementById('btnSearch');
const btnOdai = document.getElementById('btnOdai');
const btnReset = document.getElementById('btnReset');
const btnRecord = document.getElementById('btnRecord');
const statusState = document.getElementById('statusState');
const preview = document.getElementById('preview');
const logBox = document.getElementById('logBox');
const framesCount = document.getElementById('framesCount');

let currentMode = 'odai'; // 'odai' or 'search'
let capturing = false;
let capTimer = null;
let capCount = 0;
const CAP_INTERVAL = 1000;
const CAP_MAX = 10;

/* logging */
function addLog(msg){
  const t = new Date().toLocaleTimeString();
  const div = document.createElement('div');
  div.textContent = `[${t}] ${msg}`;
  logBox.prepend(div);
  // keep short
  while(logBox.childElementCount > 60) logBox.removeChild(logBox.lastChild);
}

/* Mode UI update */
function updateModeUI(){
  // reset classes to default (white)
  btnSearch.classList.remove('search-active','odai-active');
  btnOdai.classList.remove('search-active','odai-active');
  btnSearch.style.background = ''; btnSearch.style.color = '';
  btnOdai.style.background = ''; btnOdai.style.color = '';

  if(currentMode === 'search'){
    btnSearch.classList.add('search-active');
    // style for other to white default (already default)
    statusState.textContent = '探索モード（待機中）';
    statusState.style.color = 'var(--white)';
  } else {
    btnOdai.classList.add('odai-active');
    statusState.textContent = 'お題モード（待機中）';
    statusState.style.color = 'var(--white)';
  }
}

/* Camera start */
async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" }, width:{ideal:1280}, height:{ideal:720} },
      audio: false
    });
    preview.srcObject = stream;
    await preview.play();
    addLog('カメラ起動');
  }catch(e){
    console.error(e);
    addLog('カメラ起動失敗: ' + (e && e.message ? e.message : e));
    alert('カメラ起動に失敗しました。HTTPSで開いているか、カメラ権限を確認してください。\n' + (e && e.message ? e.message : ''));
  }
}

/* Capture frame as dataURL (for later OCR or demo) */
function captureFrameDataURL(){
  if(!preview || preview.readyState < 2) return null;
  const w = preview.videoWidth;
  const h = preview.videoHeight;
  const canvas = document.createElement('canvas');
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(preview,0,0,canvas.width,canvas.height);
  return canvas.toDataURL('image/jpeg', 0.9);
}

/* Long press capture logic (1s interval) */
function startLongPressCapture(){
  if(capturing) return;
  capturing = true;
  capCount = 0;
  framesCount.textContent = '0';
  // update status
  statusState.textContent = (currentMode === 'odai') ? 'お題モード（撮影中）' : '探索モード（撮影中）';
  statusState.style.color = 'var(--red)';
  addLog('読み取り開始');
  // immediate first capture
  (async ()=>{
    capCount++;
    framesCount.textContent = capCount;
    const data = captureFrameDataURL();
    addLog(`フレーム取得 ${capCount}`);
  })();
  capTimer = setInterval(()=>{
    if(capCount >= CAP_MAX){ stopLongPressCapture(); return; }
    capCount++;
    framesCount.textContent = capCount;
    const data = captureFrameDataURL();
    addLog(`フレーム取得 ${capCount}`);
  }, CAP_INTERVAL);
}

function stopLongPressCapture(){
  if(!capturing) return;
  capturing = false;
  if(capTimer){ clearInterval(capTimer); capTimer = null; }
  // restore status color depending on mode
  statusState.textContent = (currentMode === 'odai') ? 'お題モード（待機中）' : '探索モード（待機中）';
  // color: for clarity, waiting color is white
  statusState.style.color = 'var(--white)';
  addLog('読み取り終了');
}

/* Reset function: clear left slots */
function resetLeftSlots(){
  for(let r=1;r<=ROWS;r++){
    for(let c=1;c<=COLS;c++){
      const el = document.getElementById(`slot-r${r}-c${c}`);
      if(el){
        el.innerHTML = `<div class="label">${c===1 ? '未セット' : '候補 ' + (c-1)}</div>`;
      }
    }
  }
  addLog('お題リセット実行');
}

/* Event wiring */
btnSearch.addEventListener('click', ()=>{
  currentMode = 'search';
  updateModeUI();
  addLog('モード切替: 探索モード');
});
btnOdai.addEventListener('click', ()=>{
  currentMode = 'odai';
  updateModeUI();
  addLog('モード切替: お題撮影モード');
});
btnReset.addEventListener('click', ()=>{
  resetLeftSlots();
});
btnRecord.addEventListener('pointerdown', (e)=>{
  e.preventDefault();
  startLongPressCapture();
});
document.addEventListener('pointerup', ()=> stopLongPressCapture());
document.addEventListener('touchend', ()=> stopLongPressCapture());

/* init */
(function init(){
  updateModeUI();
  addLog('起動: 準備完了');
  startCamera();
})();
</script>
</body>
</html>
