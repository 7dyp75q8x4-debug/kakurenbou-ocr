<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã‹ãã‚Œã‚“ã¼ OCR â€” æƒ…å ±å„ªå…ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</title>
<style>
  :root{
    --ui-width: 34vw;   /* å³å´UIå¹…ï¼ˆèª¿æ•´å¯ï¼‰ */
    --cam-width: calc(100vw - var(--ui-width));
    --accent: #1e3cff;
    --bg: #0f0f0f;
  }
  html,body{height:100%;margin:0;background:#000;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,"Yu Gothic",sans-serif;color:#fff}
  /* --- ã‚«ãƒ¡ãƒ©é ˜åŸŸï¼ˆå·¦ï¼‰ --- */
  #cameraWrap{
    position:fixed; left:0; top:0;
    width:var(--cam-width); height:100vh;
    background:#000; display:flex; align-items:center; justify-content:center;
    overflow:hidden;
  }
  video#camera{
    width:100%; height:100%; object-fit:cover; background:#000;
  }

  /* --- å³UI --- */
  #ui {
    position:fixed; right:0; top:0;
    width:var(--ui-width); height:100vh;
    background: linear-gradient(180deg,#111 0%, #0b0b0b 100%);
    box-shadow: -8px 0 18px rgba(0,0,0,0.6);
    padding:12px; box-sizing:border-box; display:flex; flex-direction:column; gap:12px;
  }

  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
  #status {
    background:var(--accent); color:#fff; font-weight:600;
    padding:10px; text-align:center; border-radius:10px; font-size:18px;
  }

  /* æ“ä½œç”¨ãƒœã‚¿ãƒ³ç¾¤ï¼ˆå°ã•ã‚ã«ï¼‰ */
  .btnRow { display:flex; gap:10px; }
  .smallBtn {
    flex:1; height:72px; border-radius:12px; border:0;
    background:#2b2b2b; color:#fff; font-size:16px; font-weight:600;
    display:flex; align-items:center; justify-content:center;
  }
  .smallBtn:active{ transform:translateY(1px); filter:brightness(1.05); }

  #shootBtn { background:#c33; }

  /* æƒ…å ±ãƒ‘ãƒãƒ«ï¼ˆå¤§ããï¼‰ */
  #infoPanel {
    margin-top:6px; background:rgba(20,20,20,0.9); border-radius:12px;
    padding:12px; flex:1; overflow:auto; box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);
  }
  .sectionTitle { font-weight:700; font-size:16px; margin-bottom:8px; color:#ffd; }
  .dataBox { background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; font-size:15px; line-height:1.5; color:#eee; }

  /* ã‚µãƒ ãƒãƒ¼ãƒ«åˆ—ï¼ˆæ’®å½±å±¥æ­´ï¼‰ */
  #thumbs { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
  .thumb { width:72px; height:50px; object-fit:cover; border-radius:6px; border:2px solid rgba(255,255,255,0.04); }

  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¾®èª¿æ•´ï¼ˆæ¥µç«¯ã«å°ã•ã„æ¨ªå¹…å‘ã‘ï¼‰ */
  @media (max-width:900px){
    :root{ --ui-width: 36vw; }
    .smallBtn{ height:64px; font-size:15px; }
    .thumb{ width:60px; height:42px; }
  }
</style>
</head>
<body>

<!-- å·¦ï¼šã‚«ãƒ¡ãƒ© -->
<div id="cameraWrap">
  <video id="camera" autoplay playsinline muted></video>
</div>

<!-- å³ï¼šUIï¼ˆä¸Šï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹/ãƒœã‚¿ãƒ³ã€ä¸‹ï¼šæƒ…å ±ãƒ‘ãƒãƒ«å¤§ï¼‰ -->
<div id="ui">
  <div id="status">ğŸŸ¦ å¾…æ©Ÿä¸­</div>

  <div class="btnRow">
    <button id="btnTopic" class="smallBtn">ğŸ“· ãŠé¡Œæ’®å½±</button>
    <button id="btnSearch" class="smallBtn">ğŸ” ã‚«ãƒ¼ãƒ‰æ¢ç´¢</button>
  </div>

  <div class="btnRow">
    <button id="btnTest" class="smallBtn">ğŸ¥ ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆ</button>
    <button id="shootBtn" class="smallBtn">ğŸ“¸ é•·æŠ¼ã—æ’®å½±</button>
  </div>

  <!-- å¤§ããªæƒ…å ±ãƒ‘ãƒãƒ«ï¼ˆç›¸å½“é‡è¦ï¼‰ -->
  <div id="infoPanel">
    <div class="sectionTitle">ğŸ“‹ èª­ã¿å–ã‚Šçµæœï¼ˆé‡è¦é ˜åŸŸï¼‰</div>

    <div style="margin-bottom:8px">
      <div style="font-weight:700; color:#ffd; margin-bottom:6px">ãŠé¡Œï¼ˆ3æ¡ã®æ•°å­—ãƒ»ã‚¹ã‚­ãƒ£ãƒ³ä¸€è¦§ï¼‰</div>
      <div id="topics" class="dataBox">ï¼ˆã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰</div>
    </div>

    <div style="margin-top:10px">
      <div style="font-weight:700; color:#ffd; margin-bottom:6px">ã‚«ãƒ¼ãƒ‰æ¢ç´¢ â€” å€™è£œ TOP 3</div>
      <div id="candidates" class="dataBox">ï¼ˆã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰</div>
    </div>

    <div style="margin-top:12px">
      <div style="font-weight:700; color:#ffd; margin-bottom:6px">æ’®å½±å±¥æ­´ï¼ˆæœ€å¤§10æšï¼‰</div>
      <div id="thumbs"></div>
    </div>
  </div>
</div>

<script>
/* -----------------------------
   å®‰å®šã—ã¦æ˜ ã‚‹ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼ˆiOS å¯¾ç­–ï¼‰
   - facingMode: ideal "environment"
   - playsinline / muted / autoplay
----------------------------- */
const video = document.getElementById('camera');
let stream = null;

async function startCamera() {
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: "environment" },
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false
    });
    video.srcObject = stream;
    document.getElementById('status').textContent = 'ğŸŸ¦ å¾…æ©Ÿä¸­';
  } catch (err) {
    console.error('ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:', err);
    alert('ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã§ãã¾ã›ã‚“ã€‚ã‚µã‚¤ãƒˆã®ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    document.getElementById('status').textContent = 'âš  ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼';
  }
}
startCamera();

/* -----------------------------
   çŠ¶æ…‹ãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†
----------------------------- */
let mode = 'topic'; // 'topic' or 'search'
let isHolding = false;
let holdInterval = null;
let captureHistory = []; // blob urls for thumbs (max 10)
let topics = [];         // array of strings (3-digit numbers)
let candidateCounts = {}; // map num->score for simple ranking

/* UI refs */
const statusEl = document.getElementById('status');
const topicsEl = document.getElementById('topics');
const candidatesEl = document.getElementById('candidates');
const thumbsEl = document.getElementById('thumbs');

/* ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ */
document.getElementById('btnTopic').addEventListener('click', () => { mode='topic'; statusEl.textContent='ğŸŸ¦ ãŠé¡Œæ’®å½±ãƒ¢ãƒ¼ãƒ‰'; });
document.getElementById('btnSearch').addEventListener('click', () => { mode='search'; statusEl.textContent='ğŸŸ¦ ã‚«ãƒ¼ãƒ‰æ¢ç´¢ãƒ¢ãƒ¼ãƒ‰'; });
document.getElementById('btnTest').addEventListener('click', () => { startCamera(); statusEl.textContent='ğŸŸ¦ ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆ'; });

/* é•·æŠ¼ã—æ’®å½±ï¼ˆ0.5ç§’ã§1æšæ’®å½±ã€‚æŠ¼ã—ç¶šã‘ãŸã‚‰ 1 ç§’ã”ã¨ã®é€£å†™ã«è‡ªå‹•ç§»è¡Œï¼‰ */
const shootBtn = document.getElementById('shootBtn');
shootBtn.addEventListener('touchstart', onHoldStart, {passive:false});
shootBtn.addEventListener('mousedown', onHoldStart);
shootBtn.addEventListener('touchend', onHoldEnd);
shootBtn.addEventListener('mouseup', onHoldEnd);
shootBtn.addEventListener('mouseleave', onHoldEnd);

function onHoldStart(e){
  e.preventDefault();
  if (isHolding) return;
  isHolding = true;
  statusEl.textContent = 'ğŸ”´ æ’®å½±ä¸­';
  // 0.5ç§’ã§1æšæ’®ã‚‹ â†’ ãã®å¾Œæ¯ç§’1æš
  holdInterval = setTimeout(() => {
    if (!isHolding) return;
    captureAndProcess();
    // start interval every 1s
    holdInterval = setInterval(() => captureAndProcess(), 1000);
  }, 500);
  // also capture immediate short press behaviour (optional): capture on start
  // captureAndProcess();
}

function onHoldEnd(e){
  e && e.preventDefault && e.preventDefault();
  if (!isHolding) return;
  isHolding = false;
  statusEl.textContent = 'ğŸŸ¦ å¾…æ©Ÿä¸­';
  if (holdInterval) {
    clearTimeout(holdInterval);
    holdInterval = null;
  }
}

/* -----------------------------
   ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼†ç°¡æ˜“è§£æ
   - ç¾æ™‚ç‚¹ã¯ã€Œç”»åƒã‚’æ’®ã£ã¦ã‚µãƒ ãƒè¼‰ã›ã€ã€Œç”»åƒã‹ã‚‰3æ¡ã‚’æŠ½å‡ºã™ã‚‹å ´æ‰€ã‚’ç”¨æ„ã€
   - å®Ÿé‹ç”¨ã¯ã“ã“ã« OCR ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆe.g. Tesseract.jsï¼‰ã‚’å°å…¥ã—ã¦
     OCR çµæœãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ 3æ¡ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„
----------------------------- */
function captureAndProcess(){
  if (!video || !video.videoWidth) { console.warn('video not ready'); return; }

  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã‚µãƒ ãƒã‚¤ãƒ«
  canvas.toBlob(blob => {
    const url = URL.createObjectURL(blob);
    pushThumb(url);
  }, 'image/jpeg', 0.8);

  // === OCR ã‚’å…¥ã‚Œã‚‹å ´æ‰€ã“ã“ ===
  // ä¾‹: tesseract ã‚’å…¥ã‚ŒãŸã‚‰ OCR ã‚’å‘¼ã³ã€æˆ»ã‚Šæ–‡å­—åˆ—ã‹ã‚‰ 3æ¡ã®ã¿ã‚’æŠœã
  // ä»Šã¯ãƒ‡ãƒ¢ã®ãŸã‚ã€Œç”»åƒå†…ã«åŸ‹ã‚ã‚‰ã‚ŒãŸæ•°å­—ã®æ–‡å­—åˆ—ã‚’ä»®ã« '123' ã¨ã™ã‚‹ã€ã‹ã€
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§å…¥ã‚Œã‚‰ã‚Œã‚‹UIã‚’è¿½åŠ ã™ã‚‹æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚
  //
  // ä»®å‡¦ç†ï¼ˆãƒ‡ãƒ¢ï¼‰ï¼šã‚«ãƒ¡ãƒ©ã‹ã‚‰ã®è§£æçµæœã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§ç”Ÿæˆï¼ˆæœ¬ç•ªã¯OCRã«ç½®æ›ï¼‰
  //
  const demoCandidates = generateDemo3Digit(); // ãƒ‡ãƒ¢ç”¨ â€” æœ¬ç•ªã¯OCRã§ç½®ãæ›ãˆ
  handleDetectedNumbers(demoCandidates);
}

/* demoï¼šãƒ©ãƒ³ãƒ€ãƒ ã« 3æ¡æ•°å­—ã‚’è¿”ã™ï¼ˆOCR å®Ÿè£…å‰ã®ä»®ï¼‰ */
function generateDemo3Digit(){
  const n = Math.floor(Math.random()*900)+100;
  return [String(n)];
}

/* æŠ½å‡ºçµæœã®æ‰±ã„ï¼š
   - mode === 'topic' â†’ topics[] ã«è¿½åŠ ï¼ˆ3æ¡ã®ã¿ï¼‰
   - mode === 'search' â†’ å€™è£œã‚¹ã‚³ã‚¢ã‚’å¢—ã‚„ã—ä¸Šä½3ã‚’æ›´æ–°
*/
function handleDetectedNumbers(arrNums){
  if (!Array.isArray(arrNums) || arrNums.length===0) return;
  for (const s of arrNums){
    const m = s.match(/^\d{3}$/);
    if (!m) continue; // 3æ¡ä»¥å¤–ã¯é™¤å¤–
    if (mode === 'topic'){
      // é‡è¤‡ã‚’é¿ã‘ã¤ã¤è¿½åŠ ï¼ˆæœ€è¿‘ãŒå³ï¼‰
      if (!topics.includes(s)) topics.push(s);
      if (topics.length>20) topics.shift();
    } else {
      // ã‚«ãƒ¼ãƒ‰æ¢ç´¢ï¼šã‚¹ã‚³ã‚¢ã‚’ç°¡æ˜“é›†è¨ˆ
      candidateCounts[s] = (candidateCounts[s]||0) + 1;
    }
  }
  refreshUI();
}

/* UIæ›´æ–°ï¼štopics ã¨ candidates ã‚’è¡¨ç¤º */
function refreshUI(){
  topicsEl.textContent = topics.length ? topics.join('  /  ') : 'ï¼ˆãªã—ï¼‰';

  // ä¸Šä½3ï¼ˆcandidateCounts ã®ã‚¹ã‚³ã‚¢é †ï¼‰
  const arr = Object.keys(candidateCounts);
  arr.sort((a,b)=> (candidateCounts[b]||0)-(candidateCounts[a]||0));
  const top3 = arr.slice(0,3);
  if (top3.length===0){
    candidatesEl.textContent = 'ï¼ˆãªã—ï¼‰';
  } else {
    candidatesEl.innerHTML = top3.map((k,i)=>`${i+1}ä½: ${k} ï¼ˆ${candidateCounts[k]}ï¼‰`).join('<br>');
  }
}

/* ã‚µãƒ ãƒç®¡ç†ï¼ˆæœ€å¤§10æšï¼‰ */
function pushThumb(url){
  captureHistory.unshift(url);
  if (captureHistory.length>10){
    const last = captureHistory.pop();
    URL.revokeObjectURL(last);
  }
  renderThumbs();
}

function renderThumbs(){
  thumbsEl.innerHTML = '';
  for (const u of captureHistory){
    const img = document.createElement('img');
    img.src = u; img.className='thumb';
    thumbsEl.appendChild(img);
  }
}

/* -----------------------------
   ä¾¿åˆ©ï¼šOCR ã‚’å°å…¥ã™ã‚‹å ´åˆã®ãƒ’ãƒ³ãƒˆï¼ˆã‚³ãƒ¡ãƒ³ãƒˆï¼‰
   - Tesseract.js ã‚’ CDN ã§èª­ã¿è¾¼ã‚“ã§ OCR
     (ä¾‹) <script src="https://unpkg.com/tesseract.js@v2.1.5/dist/tesseract.min.js"></script>
   - captureAndProcess() å†…ã§ canvas ã‚’ blob ã«ã—ã¦ Tesseract.recognize(blob, 'eng') ãªã©ã‚’å‘¼ã¶
   - è¿”ã£ã¦ããŸãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ /\b\d{3}\b/g ã§ 3æ¡ã‚’æŠœãå‡ºã— handleDetectedNumbers() ã«æ¸¡ã™
----------------------------- */

</script>
</body>
</html>
