<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã‹ãã‚Œã‚“ã¼ OCR â€” è‡ªå‹•åˆ‡ã‚ŠæŠœãç‰ˆ</title>

<!-- Tesseract.js CDN -->
<script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

<style>
  /* --- å…¨ä½“ï¼ˆæ¨ªæŒã¡æƒ³å®šï¼‰ --- */
  html,body{height:100%; margin:0; background:#000; color:#fff; font-family: -apple-system, system-ui, "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;}
  #app{
    width:100vw; height:100vh; box-sizing:border-box; padding:6px;
    display:grid;
    grid-template-columns: 120px 1fr 180px; /* å·¦=ãŠé¡Œåˆ— ä¸­å¤®=å€™è£œ å³=ãƒœã‚¿ãƒ³+ã‚«ãƒ¡ãƒ© */
    grid-template-rows: repeat(5, 1fr);
    gap:6px;
    overflow:hidden;
  }

  /* å·¦åˆ—ï¼šãŠé¡Œï¼ˆå„ã‚»ãƒ«ã¯æ­£æ–¹å½¢ã®è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼‰ */
  .odai{
    background:#0f0f11; border-radius:8px; display:flex; align-items:center; justify-content:center;
    position:relative; overflow:hidden; border:1px solid #222;
  }
  .odai .label{
    position:absolute; left:6px; top:6px; font-weight:700; font-size:18px; color:#fff;
  }
  .odai img{ width:100%; height:100%; object-fit:cover; display:block; }

  /* ä¸­å¤®åˆ—ï¼šå„ãŠé¡Œã”ã¨ã®å€™è£œTOP3ï¼ˆå†™çœŸ + ãƒ†ã‚­ã‚¹ãƒˆï¼‰ */
  .candidates{
    background:transparent; border-radius:8px; padding:8px; display:flex; flex-direction:column; gap:8px; box-sizing:border-box;
  }
  .candidateRow{
    background:#121212; border-radius:8px; padding:8px; display:flex; gap:8px; align-items:center; justify-content:space-between;
    height:100%;
    box-sizing:border-box;
  }
  .candItem{
    background:#1b1b1b; border-radius:6px; padding:6px; width:30%; display:flex; gap:8px; align-items:center; box-sizing:border-box;
  }
  .candItem img{ width:56px; height:56px; object-fit:cover; border-radius:6px; background:#000;}
  .candText{ font-size:16px; line-height:1.1; }

  /* å³åˆ—ï¼šãƒœã‚¿ãƒ³ï¼ˆä¸Š3æ®µï¼‰ã¨ã‚«ãƒ¡ãƒ©ï¼ˆä¸‹2æ®µï¼‰ */
  #rightPanel{
    grid-row:1 / 6; /* é«˜ã•ã‚’å…¨è¡Œã« */
    background:transparent; display:flex; flex-direction:column; gap:8px; padding:6px; box-sizing:border-box;
  }
  .buttons{
    display:flex; flex-wrap:wrap; gap:8px; justify-content:center;
  }
  .btn{
    width:72px; height:72px; background:#2a2a2a; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:26px; cursor:pointer;
    border:2px solid rgba(255,255,255,0.03);
  }
  #shootBtn{ background: #c42b2b; }

  /* ã‚«ãƒ¡ãƒ©æ ï¼ˆå³ä¸‹ï¼‰ */
  #camBox{ margin-top:auto; width:100%; display:flex; align-items:center; justify-content:center; }
  #camInner{ width:160px; height:120px; background:#000; border-radius:10px; overflow:hidden; border:2px solid #222; }
  #camera{ width:100%; height:100%; object-fit:cover; display:block; }

  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ï¼ˆå³ä¸Šã«å°ã•ãï¼‰ */
  #status{ position:absolute; right:12px; top:12px; background:#1e3cff; color:#fff; padding:6px 10px; border-radius:8px; font-weight:700; z-index:10; }

  /* small helper */
  .small{font-size:12px; opacity:0.85;}
</style>
</head>
<body>
<div id="status">ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­â€¦</div>

<div id="app">
  <!-- å·¦ï¼šãŠé¡Œ 1..5 -->
  <div class="odai" id="odai1"><div class="label">ãŠé¡Œ1</div><img id="odai1_img" alt=""></div>
  <div class="odai" id="odai2"><div class="label">ãŠé¡Œ2</div><img id="odai2_img" alt=""></div>
  <div class="odai" id="odai3"><div class="label">ãŠé¡Œ3</div><img id="odai3_img" alt=""></div>
  <div class="odai" id="odai4"><div class="label">ãŠé¡Œ4</div><img id="odai4_img" alt=""></div>
  <div class="odai" id="odai5"><div class="label">ãŠé¡Œ5</div><img id="odai5_img" alt=""></div>

  <!-- ä¸­å¤®ï¼šå„ãŠé¡Œã«å¯¾å¿œã™ã‚‹å€™è£œTOP3 -->
  <div class="candidates" id="cand1"><div class="candidateRow" id="candRow1">
    <div class="candItem"><img id="c1_1_img"/><div class="candText" id="c1_1_txt">â€”</div></div>
    <div class="candItem"><img id="c1_2_img"/><div class="candText" id="c1_2_txt">â€”</div></div>
    <div class="candItem"><img id="c1_3_img"/><div class="candText" id="c1_3_txt">â€”</div></div>
  </div></div>

  <div class="candidates" id="cand2"><div class="candidateRow" id="candRow2">
    <div class="candItem"><img id="c2_1_img"/><div class="candText" id="c2_1_txt">â€”</div></div>
    <div class="candItem"><img id="c2_2_img"/><div class="candText" id="c2_2_txt">â€”</div></div>
    <div class="candItem"><img id="c2_3_img"/><div class="candText" id="c2_3_txt">â€”</div></div>
  </div></div>

  <div class="candidates" id="cand3"><div class="candidateRow" id="candRow3">
    <div class="candItem"><img id="c3_1_img"/><div class="candText" id="c3_1_txt">â€”</div></div>
    <div class="candItem"><img id="c3_2_img"/><div class="candText" id="c3_2_txt">â€”</div></div>
    <div class="candItem"><img id="c3_3_img"/><div class="candText" id="c3_3_txt">â€”</div></div>
  </div></div>

  <div class="candidates" id="cand4"><div class="candidateRow" id="candRow4">
    <div class="candItem"><img id="c4_1_img"/><div class="candText" id="c4_1_txt">â€”</div></div>
    <div class="candItem"><img id="c4_2_img"/><div class="candText" id="c4_2_txt">â€”</div></div>
    <div class="candItem"><img id="c4_3_img"/><div class="candText" id="c4_3_txt">â€”</div></div>
  </div></div>

  <div class="candidates" id="cand5"><div class="candidateRow" id="candRow5">
    <div class="candItem"><img id="c5_1_img"/><div class="candText" id="c5_1_txt">â€”</div></div>
    <div class="candItem"><img id="c5_2_img"/><div class="candText" id="c5_2_txt">â€”</div></div>
    <div class="candItem"><img id="c5_3_img"/><div class="candText" id="c5_3_txt">â€”</div></div>
  </div></div>

  <!-- å³åˆ—ï¼šãƒœã‚¿ãƒ³ã¨ã‚«ãƒ¡ãƒ©æ ï¼ˆå›ºå®šï¼‰ -->
  <div id="rightPanel">
    <div class="buttons">
      <div class="btn" id="btnTopic" title="ãŠé¡Œæ’®å½±">ğŸ“¸</div>
      <div class="btn" id="btnSearch" title="ã‚«ãƒ¼ãƒ‰æ¢ç´¢">ğŸ”</div>
      <div class="btn" id="btnReset" title="ãƒªã‚»ãƒƒãƒˆ">â™»ï¸</div>
      <div class="btn" id="shootBtn" title="é•·æŠ¼ã—ã§æ’®å½±">â—</div>
    </div>

    <div id="camBox">
      <div id="camInner">
        <video id="camera" autoplay playsinline muted></video>
      </div>
    </div>
    <div class="small" style="margin-top:6px; text-align:center;">é•·æŠ¼ã—ã§æ’®å½±ï¼ˆ1æšï¼1ç§’ï¼‰</div>
  </div>
</div>

<script>
/* ==========================
   å®šæ•°ã¨çŠ¶æ…‹
   ========================== */
const SCAN_INTERVAL_MS = 1000; // 1ç§’ã”ã¨ã«OCRï¼ˆå¿…è¦ã«å¿œã˜ã¦1500ã€œ2000ã«ï¼‰
const MAX_TOPICS = 5;

let mode = 'topic'; // 'topic' or 'search'
let isHolding = false;
let scanTimer = null;

/* ãŠé¡Œãƒ‡ãƒ¼ã‚¿ï¼š{num:'123', imgDataUrl:'data:...'} max 5 */
let topics = []; 

/* ãƒãƒƒãƒ—: number -> {letter->count, examples:[{img,letter}] } */
let numberMap = {}; 

/* Tesseract worker */
let worker = null;
const statusEl = document.getElementById('status');

/* ã‚«ãƒ¡ãƒ©ã¨ã‚­ãƒ£ãƒ³ãƒã‚¹ */
const video = document.getElementById('camera');
const tmpCanvas = document.createElement('canvas');
const tmpCtx = tmpCanvas.getContext('2d');

/* ==========================
   Tesseract ãƒ¯ãƒ¼ã‚«ãƒ¼åˆæœŸåŒ–
   ========================== */
async function initTesseract(){
  statusEl.textContent = 'ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­â€¦';
  worker = Tesseract.createWorker({
    logger: m => {
      // console.log(m);
      if(m.status && m.status.includes('loaded')){
        statusEl.textContent = 'ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å®Œäº†';
      }
    }
  });
  await worker.load();
  await worker.loadLanguage('eng'); // æ•°å­—ã¨è‹±å­—ã‚’æ‰±ã†
  await worker.initialize('eng');
  // ä½™è¨ˆãªå‡ºåŠ›æ¸›ã‚‰ã™
  await worker.setParameters({
    tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz',
    preserve_interword_spaces: '0'
  });
  statusEl.textContent = 'æº–å‚™å®Œäº†ï¼ˆå¾…æ©Ÿä¸­ï¼‰';
}
initTesseract();

/* ==========================
   ã‚«ãƒ¡ãƒ©èµ·å‹•
   ========================== */
async function startCamera(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' }, width:{ideal:1280}, height:{ideal:720} },
      audio:false
    });
    video.srcObject = s;
    video.play();
    statusEl.textContent = 'ã‚«ãƒ¡ãƒ©èµ·å‹•å®Œäº†ï¼ˆå¾…æ©Ÿä¸­ï¼‰';
  }catch(err){
    statusEl.textContent = 'ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—';
    console.error(err);
  }
}
startCamera();

/* ==========================
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼šã‚¤ãƒ¡ãƒ¼ã‚¸åˆ‡ã‚ŠæŠœãï¼ˆå››è§’ï¼šæ‹¡å¼µã¤ãï¼‰ => dataURL
   bbox: {x0,y0,x1,y1} in pixels of canvas
   returns dataURL
   ========================== */
function cropSquareFromCanvas(canvas, bbox, expand=0.2){
  const w = canvas.width, h = canvas.height;
  const cx = (bbox.x0 + bbox.x1)/2;
  const cy = (bbox.y0 + bbox.y1)/2;
  const bw = bbox.x1 - bbox.x0;
  const bh = bbox.y1 - bbox.y0;
  const size = Math.max(bw,bh) * (1 + expand);
  const sx = Math.max(0, Math.round(cx - size/2));
  const sy = Math.max(0, Math.round(cy - size/2));
  const sW = Math.min(w - sx, Math.round(size));
  const sH = Math.min(h - sy, Math.round(size));

  const tmp = document.createElement('canvas');
  tmp.width = sW;
  tmp.height = sH;
  tmp.getContext('2d').drawImage(canvas, sx, sy, sW, sH, 0,0, sW, sH);
  // resize to square display size for left column
  const out = document.createElement('canvas');
  const S = 200; // left-cells display ã§ä½¿ã†ã‚µã‚¤ã‚ºï¼ˆæ­£æ–¹å½¢ï¼‰
  out.width = S; out.height = S;
  out.getContext('2d').drawImage(tmp, 0,0, S,S);
  return out.toDataURL('image/jpeg', 0.9);
}

/* ==========================
   OCRå‡¦ç†ï¼š1ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è§£æã—ã¦å˜èªæƒ…å ±ã‚’è¿”ã™
   returns array of words: {text,bbox:{x0,y0,x1,y1},confidence}
   ========================== */
async function ocrFrameWithBoxes(canvas){
  // use worker.recognize with canvas
  const { data } = await worker.recognize(canvas);
  // data.words[] has bbox
  const words = (data && data.words) ? data.words.map(w=>({
    text: (w.text||'').trim(),
    bbox: { x0: w.bbox.x0, y0: w.bbox.y0, x1: w.bbox.x1, y1: w.bbox.y1 },
    conf: w.confidence
  })) : [];
  return words;
}

/* ==========================
   ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç†ï¼ˆå‘¼ã³å‡ºã—å…ƒï¼šé•·æŠ¼ã—ä¸­ã® setIntervalï¼‰
   - topic mode: æ¤œå‡ºã—ãŸ3æ¡ã‚’å·¦åˆ—ã«é †æ¬¡å…¥ã‚Œã‚‹
   - search mode: æ¤œå‡ºã—ãŸ3æ¡ã¨è¿‘å‚ã®è‹±å­—ã‚’ numberMap ã«è¿½åŠ 
   ========================== */
async function processScan(){
  if(!video.videoWidth) return;
  // draw current frame to tmp canvas
  tmpCanvas.width = video.videoWidth;
  tmpCanvas.height = video.videoHeight;
  tmpCtx.drawImage(video, 0, 0, tmpCanvas.width, tmpCanvas.height);

  // OCRãƒ•ãƒ¬ãƒ¼ãƒ è§£æï¼ˆéãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰
  const words = await ocrFrameWithBoxes(tmpCanvas);
  if(!words || words.length===0) return;

  // 1) find all 3-digit numeric tokens
  const threeDigits = words.filter(w => /^\d{3}$/.test(w.text));

  // if none found, return quickly
  if(threeDigits.length === 0) return;

  if(mode === 'topic'){
    // for each detected 3-digit, crop and add to topics (max 5)
    for(const w of threeDigits){
      const num = w.text;
      // avoid duplicates
      if(topics.find(t=>t.num===num)) continue;
      if(topics.length >= MAX_TOPICS) break;
      const imgData = cropSquareFromCanvas(tmpCanvas, w.bbox, 0.4); // extend for safety
      topics.push({ num, img: imgData });
      updateLeftTopicsUI();
      if(topics.length >= MAX_TOPICS) break;
    }
  }else if(mode === 'search'){
    // Build quick spatial index: for each numeric bbox, find nearest single-letter word (A-Z)
    const letters = words.filter(w=>/^[A-Za-z]$/.test(w.text));
    for(const w of threeDigits){
      const num = w.text;
      // find nearest letter by Euclidean distance of bbox centers (within reasonable range)
      const bx = (w.bbox.x0 + w.bbox.x1)/2;
      const by = (w.bbox.y0 + w.bbox.y1)/2;
      let nearest = null; let bestD = Infinity;
      for(const L of letters){
        const lx = (L.bbox.x0 + L.bbox.x1)/2;
        const ly = (L.bbox.y0 + L.bbox.y1)/2;
        const d = Math.hypot(lx-bx, ly-by);
        if(d < bestD){ bestD = d; nearest = L; }
      }
      // threshold: only accept if distance < some fraction of frame diag
      const diag = Math.hypot(tmpCanvas.width, tmpCanvas.height);
      if(nearest && bestD < diag * 0.18){
        const letter = nearest.text.toUpperCase();
        // crop tile image around numeric bbox (bigger)
        const cropImg = cropSquareFromCanvas(tmpCanvas, w.bbox, 0.6);
        if(!numberMap[num]) numberMap[num] = { counts: {}, examples: [] };
        numberMap[num].counts[letter] = (numberMap[num].counts[letter]||0) + 1;
        numberMap[num].examples.push({letter, img: cropImg});
      } else {
        // if no nearby letter, still store example with blank letter for visual
        const cropImg = cropSquareFromCanvas(tmpCanvas, w.bbox, 0.6);
        if(!numberMap[num]) numberMap[num] = { counts: {}, examples: [] };
        numberMap[num].examples.push({letter: '-', img: cropImg});
      }
    }
    // after updating, refresh candidate UI
    updateCandidatesUI();
  }
}

/* ==========================
   UI æ›´æ–°ï¼šå·¦åˆ—ã®ãŠé¡Œç”»åƒã‚’è¡¨ç¤º
   ========================== */
function updateLeftTopicsUI(){
  for(let i=0;i<MAX_TOPICS;i++){
    const el = document.getElementById(`odai${i+1}_img`);
    if(topics[i]) el.src = topics[i].img;
    else el.removeAttribute('src');
  }
}

/* ==========================
   UI æ›´æ–°ï¼šä¸­å¤®ã®å€™è£œTOP3ï¼ˆå†™çœŸä»˜ãï¼‰ã‚’è¡¨ç¤º
   - for each topic number, map numberMap -> top3 letters
   ========================== */
function updateCandidatesUI(){
  // for each topic entry, compute top3
  for(let i=0;i<MAX_TOPICS;i++){
    const t = topics[i];
    const baseIndex = i+1;
    for(let j=1;j<=3;j++){
      const imgEl = document.getElementById(`c${baseIndex}_${j}_img`);
      const txtEl = document.getElementById(`c${baseIndex}_${j}_txt`);
      if(!t){ imgEl.removeAttribute('src'); txtEl.textContent = 'â€”'; continue; }

      const num = t.num;
      const info = numberMap[num];
      if(!info){
        imgEl.removeAttribute('src');
        txtEl.textContent = 'â€”';
        continue;
      }
      // build sorted list by counts
      const pairs = Object.entries(info.counts).map(([k,v])=>({k,v}));
      pairs.sort((a,b)=>b.v-a.v);
      // also include examples without letter if necessary
      let chosenLetter = null;
      if(pairs[j-1]) chosenLetter = pairs[j-1].k;
      else {
        // fallback: take examples list
        const ex = info.examples[j-1];
        if(ex) {
          imgEl.src = ex.img;
          txtEl.textContent = (ex.letter && ex.letter!=='-') ? `${ex.letter}` : 'å€™è£œ';
          continue;
        } else {
          imgEl.removeAttribute('src');
          txtEl.textContent = 'â€”';
          continue;
        }
      }
      // pick an example image for that letter
      const exExample = info.examples.find(e => e.letter === chosenLetter) || info.examples[0];
      imgEl.src = exExample ? exExample.img : '';
      txtEl.textContent = `${chosenLetter} (${info.counts[chosenLetter]||0})`;
    }
  }
}

/* ==========================
   é•·æŠ¼ã—åˆ¶å¾¡ï¼ˆæ’®å½±é–‹å§‹ï¼åœæ­¢ï¼‰
   ========================== */
const shootBtn = document.getElementById('shootBtn');
let holdInterval = null;

function onHoldStart(){
  if(isHolding) return;
  isHolding = true;
  statusEl.textContent = 'æ’®å½±ä¸­â€¦';
  statusEl.style.background = '#c42b2b';
  // start continuous scanning
  processScan(); // immediate first
  holdInterval = setInterval(processScan, SCAN_INTERVAL_MS);
}
function onHoldEnd(){
  if(!isHolding) return;
  isHolding = false;
  statusEl.textContent = 'å¾…æ©Ÿä¸­';
  statusEl.style.background = '#1e3cff';
  clearInterval(holdInterval);
  holdInterval = null;
}

shootBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); onHoldStart(); });
shootBtn.addEventListener('mousedown', (e)=>{ e.preventDefault(); onHoldStart(); });
document.addEventListener('touchend', ()=> onHoldEnd());
document.addEventListener('mouseup', ()=> onHoldEnd());

/* ==========================
   ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã¨ãƒªã‚»ãƒƒãƒˆ
   ========================== */
document.getElementById('btnTopic').addEventListener('click', ()=>{ mode='topic'; statusEl.textContent='ãƒ¢ãƒ¼ãƒ‰: ãŠé¡Œæ’®å½±ï¼ˆtopicï¼‰'; statusEl.style.background='#1e3cff'; });
document.getElementById('btnSearch').addEventListener('click', ()=>{ mode='search'; statusEl.textContent='ãƒ¢ãƒ¼ãƒ‰: ã‚«ãƒ¼ãƒ‰æ¢ç´¢ï¼ˆsearchï¼‰'; statusEl.style.background='#1e3cff'; });
document.getElementById('btnReset').addEventListener('click', ()=>{ topics=[]; numberMap={}; updateLeftTopicsUI(); updateCandidatesUI(); statusEl.textContent='ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ'; });

/* ==========================
   åˆæœŸ UI ã‚¯ãƒªã‚¢
   ========================== */
updateLeftTopicsUI();
updateCandidatesUI();

</script>
</body>
</html>
