<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>数字検出カメラ</title>

<style>
body {
    margin: 0;
    overflow: hidden;
    background: #222;
    color: white;
    display: flex;
    flex-direction: row;  /* 横画面想定 */
    height: 100vh;
}

#leftArea {
    width: 70%;                /* 左側を広く確保 */
    padding: 10px;
    overflow-y: scroll;
}

#detectedList img {
    width: 180px;
    margin: 8px;
    border: 2px solid white;
    display: block;
}

#rightArea {
    width: 30%;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px;
}

#cameraWrapper {
    width: 100%;
    aspect-ratio: 16 / 9;  /* 横長 16:9 */
    background: black;
}

#camera {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

#shootBtn {
    width: 100px;
    height: 100px;
    margin-top: 15px;
    background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><circle cx="100" cy="100" r="80" stroke="white" stroke-width="10" fill="white"/></svg>') no-repeat center/contain;
    border: none;
}

#status {
    margin-top: 10px;
    font-size: 20px;
    color: #0f0;
}
</style>
</head>

<body>

<!-- 左側：検出した候補画像 -->
<div id="leftArea">
    <h2>検出候補</h2>
    <div id="detectedList"></div>
</div>

<!-- 右側：カメラ＋ボタン -->
<div id="rightArea">

    <div id="cameraWrapper">
        <video id="camera" autoplay playsinline></video>
    </div>

    <button id="shootBtn"></button>
    <div id="status"></div>

</div>

<script>
const video = document.getElementById("camera");
const detectedList = document.getElementById("detectedList");
const statusLabel = document.getElementById("status");

// ------------- 外カメラ固定 -------------
navigator.mediaDevices.getUserMedia({
    video: { facingMode: { exact: "environment" } }
}).then(stream => {
    video.srcObject = stream;
});

// ============================
//  撮影 → OCR → 数字検出
// ============================
function captureFrame() {
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    return canvas;
}

// デモ：中央付近を切り出す（後で改善可）
function extractNumberArea(canvas) {
    const ctx = canvas.getContext("2d");

    // 上の数字位置
    const trimWidth = canvas.width * 0.25;
    const trimHeight = canvas.height * 0.15;
    const x = (canvas.width - trimWidth) / 2;
    const y = canvas.height * 0.15;

    const img = document.createElement("img");
    img.src = canvas.toDataURL("image/png");

    return img;
}

let shooting = false;
let shootInterval = null;

// 長押し撮影
document.getElementById("shootBtn").addEventListener("mousedown", () => {
    shooting = true;
    statusLabel.textContent = "撮影中…";

    shootInterval = setInterval(() => {
        const frame = captureFrame();
        const crop = extractNumberArea(frame);
        detectedList.appendChild(crop);
    }, 500); // 連写速度
});

document.addEventListener("mouseup", () => {
    shooting = false;
    statusLabel.textContent = "";
    clearInterval(shootInterval);
});
</script>

</body>
</html>
